var fieldsModule=function(){var makeNewEditorField=function(requestType,savedRequest,canReprioritize,requestTypeFieldId,fields){return new Promise((function(resolve,reject){var requestId=null;savedRequest&&"repeatRequest"!=CurrentPageMode&&(requestId=savedRequest.id);var requestTypeField=requestType.fieldsDict[requestTypeFieldId][0];if(requestType.fieldsDict[requestTypeFieldId].length>1){var groupId;if(groupId=$("#assignedUserGroupDropdown").val()?$("#assignedUserGroupDropdown").val():globalUserInfo.userGroups[0],$(".userDropdown").length>0)var userId=$("#userDropdown").val();else var userId=window.globalUserInfo.userId;var userRequestTypeField=requestType.fieldsDict[requestTypeFieldId].find(x=>x.groupId==groupId&&x.groupDefaultValue||x.userId==userId&&x.userDefaultValue||null!=x.groupId&&null!=x.userId);userRequestTypeField&&(requestTypeField=userRequestTypeField)}else requestTypeField=requestType.fieldsDict[requestTypeFieldId][0];var skipThisRequestTypeField=!1,editorField=$('<div class="editorField"></div>');editorField.attr("requesttypefieldid",requestTypeField.requestTypeFieldId),editorField.attr("allowmultiple",requestTypeField.allowMultiple),editorField.attr("fieldgroup",requestTypeField.fieldGroup),editorField.attr("clearWhenDuplicate",requestTypeField.clearWhenDuplicate),1==requestTypeField.disabled&&editorField.addClass("disabledField"),1==requestTypeField.required&&editorField.addClass("requiredField"),editorField.attr("savedfieldid",requestTypeField.savedFieldId),editorField.attr("sortorder",requestTypeField.sortOrder);var savedFieldData=null;$.each(fields,(function(savedFieldIndex,savedField){if(savedField.id==requestTypeField.savedFieldId)return savedFieldData={index:savedFieldIndex,field:savedField},!1})),new Promise((function(resolve,reject){if(null!=savedFieldData&&savedFieldData.hasOwnProperty("index")&&savedFieldData.hasOwnProperty("field")?(savedField=savedFieldData.field,savedFieldIndex=savedFieldData.index):resolve(!1),1==requestTypeField.restrictAccess&&(0==requestTypeField.canView?(skipThisRequestTypeField=!0,resolve(!1)):savedRequest&&!duplicatingRequest||0!=requestTypeField.canAdd||(skipThisRequestTypeField=!0,resolve(!1)),editorField.addClass("restrictedAccessField"),0==requestTypeField.canAdd&&editorField.addClass("noCanAdd"),0==requestTypeField.canView&&editorField.addClass("noCanView"),0==requestTypeField.canEdit&&(editorField.addClass("notEditable"),editorField.addClass("noCanEdit")),0==requestTypeField.canDelete&&editorField.addClass("noCanDelete")),savedRequestField=!1,savedRequest){var thisRequestField=savedRequest.requestFields.find(x=>x.requestTypeFieldId==requestTypeFieldId);thisRequestField&&(savedRequestField=thisRequestField,editorField.attr("requestfieldid",thisRequestField.id))}editorField.attr("datatypeid",savedField.dataTypeId),savedField.hoverText&&editorField.attr("title",savedField.hoverText);var fieldLabel=$('<label class="editorFieldLabel"></label>'),fieldLabelText=$("<span></span>").addClass("fieldLabel").text(savedField.displayName);fieldLabel.append(fieldLabelText),6==savedField.dataTypeId&&fieldLabel.append($("<br>")).append($("<span></span>").addClass("attachment-instructions").text("Drop files to upload or browse for a file.")),fieldLabel.attr("requestfieldid",editorField.attr("requestFieldId")),console.log("SAVED FIELD INDEX: ",savedFieldIndex),addRequestEditorField(savedField,savedRequestField,requestTypeField,requestId,canReprioritize).then((function(fieldInputElementContainer){editorField.append(fieldLabel,fieldInputElementContainer),console.log("RETURN SAVED FIELD INDEX: ",savedFieldIndex),resolve(editorField)})).then((function(editorField){skipThisRequestTypeField||requestTypeField.disabled?resolve(!1):resolve(editorField)}))})).then(editorField=>resolve(editorField))}))},addRequestEditorField=function(savedField,savedRequestField,requestTypeField,requestId,canReprioritize){return new Promise((function(resolve,reject){valuesArray=[!1];var editorFieldPromises=[];if(!window.duplicateRequestId&&savedRequestField)valuesArray=savedRequestField.requestFieldValues.map(x=>null==x?{textValue:"",intValue:"",realValue:"",dropDownValue:""}:x);else{var isDuplicatePage=window.location.href.indexOf("repeatRequest")>=0,clearWhenDuplicate=1==requestTypeField.clearWhenDuplicate,defaultValueObject;if(!savedRequestField||isDuplicatePage&&clearWhenDuplicate||(valuesArray=savedRequestField.requestFieldValues,console.log(valuesArray)),($(".requestEditorContainer.newRequestEditor").length>0||isDuplicatePage)&&!valuesArray[0])if(console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!  globalUesrInfo.userGroups = ",globalUserInfo.userGroups),console.log("processing default values for: ",requestTypeField),console.log("SavedFieldId: ",savedField),11==savedField.dataTypeId&&(requestTypeField.defaultValue=globalUserInfo.userId),requestTypeField.defaultValue)5==savedField.dataTypeId?(requestTypeField.defaultValue=parseInt(requestTypeField.defaultValue),defaultValueObject={dropDownValue:requestTypeField.defaultValue}):11==savedField.dataTypeId?(requestTypeField.defaultValue=parseInt(requestTypeField.defaultValue),defaultValueObject={dropDownValue:requestTypeField.defaultValue}):defaultValueObject={textValue:requestTypeField.defaultValue,intValue:requestTypeField.defaultValue,realValue:requestTypeField.defaultValue},defaultValueObject&&(valuesArray=[defaultValueObject],console.log(valuesArray))}var fieldInputElementsContainer=$("<div>");0==valuesArray.length&&valuesArray.push(!1),$.each(valuesArray,(function(requestFieldValueIndex,requestFieldValue){editorFieldPromises.push(buildRequestEditorField(requestFieldValueIndex,requestFieldValue,savedField,requestTypeField,requestId,canReprioritize))})),Promise.all(editorFieldPromises).then((function(editorFields){$.each(editorFields,(function(editorFieldIndex,editorField){fieldInputElementsContainer.append(editorField)})),resolve(fieldInputElementsContainer.children())}))}))},buildRequestEditorField=function(requestFieldValueIndex,requestFieldValue,savedField,requestTypeField,requestId,canReprioritize){return new Promise((function(resolve,reject){null==requestFieldValue&&(requestFieldValue={});var fieldPromises=[];if(console.log(requestFieldValueIndex),savedField.dataTypeId==dataTypeEnums.TEXT)var fieldInputElement=requestTypeTextGenerator(requestFieldValue.textValue);else if(savedField.dataTypeId==dataTypeEnums.LONG_TEXT)var fieldInputElement=requestTypeLongTextGenerator(requestFieldValue.textValue);else if(savedField.dataTypeId==dataTypeEnums.INTEGER)var fieldInputElement=requestTypeIntGenerator(requestFieldValue.intValue);else if(savedField.dataTypeId==dataTypeEnums.REAL_NUMBER)var fieldInputElement=requestTypeNumberGenerator(requestFieldValue.realValue);else if(savedField.dataTypeId==dataTypeEnums.DROP_DOWN)var fieldInputElement=requestTypeDropdownGenerator(savedField,requestTypeField,requestFieldValue.dropDownValue,requestId,canReprioritize);else if(savedField.dataTypeId==dataTypeEnums.FILE_ATTACHMENT){var fieldInputElement;(fieldInputElement=$('<form class="requestFieldFileAttachmentForm" onsubmit="return false;">')).append('<input type="file" class="editorFieldInput" style="display:none">'),fieldInputElement.append('<button type="submit" class="requestFieldFileAttachmentSubmitButton btn btn-sm" style="display:none">Confirm Upload</button>');var uploadBar=$("<div></div>").addClass("myBar"),resumableCurrFile=$("<div class='currFile'></div>").append($("<a href='#'></a>").addClass("currentFileLink").text("No file chosen")),resumableBrowse=$("<button class='resumable-browse'>Choose File</button>"),fileDiv=$("<div></div>").addClass("resumableFileInfo");fileDiv.append(resumableBrowse).append(resumableCurrFile);var btnDiv=$("<div></div>").addClass("resumableBtns"),pauseBtn=$("<button></button>").addClass("resumablePause"),resumeBtn=$("<button></button>").addClass("resumableGo");btnDiv.append(pauseBtn).append(resumeBtn);var fileUploadContainer=$("<div></div>").addClass("fileUploadContainer").append(fileDiv).append(btnDiv),resumableTest=$("<div></div>").addClass("resumable-drop").append(uploadBar.append(fileUploadContainer)),resumableOptions={target:"/excel2CSV/Upload",query:{connectionId:connectionId,companyId:companyId,userId:globalUserInfo.userId,appName:"Workflow"},headers:{Authorization:jwt},generateUniqueIdentifier:resumableGenerateUniqueIdentifier},fileAddedCallbackFn=function(file,rObj){fieldInputElement.find(".currentFileLink").text(file.fileName),uploadBar.css("width","0%"),removeProgressClasses(uploadBar),utilities().showUnsavedChangesNotification(uploadBar),uploadBar.addClass("myBar-upload"),btnDiv.css("display","flex"),$("#basicLoadingModal").show(),rObj.upload()},pauseCallbackFn=function(rObj){rObj.pause(),removeProgressClasses(uploadBar),uploadBar.addClass("myBar-pause")},resumeCallbackFn=function(rObj){rObj.upload(),removeProgressClasses(uploadBar),uploadBar.addClass("myBar-upload")},fileSuccessCallbackFn=function(file,response){$("#basicLoadingModal").hide(),removeProgressClasses(uploadBar),uploadBar.addClass("myBar-success"),btnDiv.hide();var responseObj="string"==typeof response?JSON.parse(response):response;fieldInputElement.attr("fileid",responseObj.fileId),-1!=responseObj.fileId&&(console.log(responseObj.fileId),$.notify({title:"Successfully uploaded file attachment.",message:""},{delay:4e3,type:"success",template:utilities().notifyJSTemplates.default}))},fileErrorCallbackFn=function(file,response){removeProgressClasses(uploadBar),uploadBar.addClass("myBar-error"),uploadBar.css("width","100%"),btnDiv.hide(),$.notify({title:"Failed to upload file attachment.",message:""},{delay:0,type:"danger"})},fileProgressCallbackFn=function(file,ratio){var progress=100*file.progress();progress=Math.floor(progress),uploadBar.css("width",progress+"%")},resumableObject=resumableModule(resumableOptions,resumableTest,resumableTest.find(".resumable-browse"));resumableObject.addFileCallback(fileAddedCallbackFn),resumableObject.addPauseButtonCallback(pauseBtn,pauseCallbackFn),resumableObject.addResumeButtonCallback(resumeBtn,resumeCallbackFn),resumableObject.addFileSuccessCallback(fileSuccessCallbackFn),resumableObject.addFileErrorCallback(fileErrorCallbackFn),resumableObject.addFileProgressCallback(fileProgressCallbackFn),fieldInputElement.append(resumableTest)}else if(savedField.dataTypeId==dataTypeEnums.DATE)if(requestFieldValue)var fieldInputElement=requestTypeDateGenerator(requestFieldValue.dateValue);else var fieldInputElement=requestTypeDateGenerator("");else if(savedField.dataTypeId==dataTypeEnums.STRUCTURE)var fieldInputElement=$('<div class="structureDisplay"></div>').attr("requestitemtypefieldid",savedField.id);else if(savedField.dataTypeId==dataTypeEnums.RICH_TEXT)var ckeId=randomString(32,"#aA"),fieldInputElement=requestTypeCKEditorGenerator(ckeId,requestFieldValue.textValue);else if(savedField.dataTypeId==dataTypeEnums.USER_LIST||savedField.dataTypeId==dataTypeEnums.CO_AUTHORS){var fieldInputElement=$('<select class="editorFieldDropdown requestFieldDropdown"></select>').append('<option value="" selected emptyDefaultOption>-- Make a Selection --</option>');fieldPromises.push(new Promise((function(resolve,reject){ajaxModule().getUsersWhoCanSeeThisExp().then((function(userList){resolve(populateUserDropdown(userList,fieldInputElement))}))})))}else if(savedField.dataTypeId==dataTypeEnums.NOTEBOOK){var randomFieldValue=Math.random().toString(36).substring(7),fieldInputElement;(fieldInputElement=$("<input></input>").attr("type","text")).addClass("searchForNotebook").addClass("select2-offscreen"),fieldInputElement.attr("id","searchForNotebook"),fieldInputElement.attr("name","searchForNotebook"),fieldInputElement.attr("title","Search for Notebook"),fieldInputElement.attr("requesttypefieldid",requestTypeField.requestTypeFieldId),fieldInputElement.attr("fieldid",randomFieldValue),fieldInputElement.attr("autogen",requestTypeField.autoGenerateNotebook),fieldInputElement.attr("bidirectionallink",requestTypeField.bidirectionalRequestLinking),"1"==requestTypeField.autoGenerateNotebook&&fieldInputElement.attr("disabled",!0)}else if(savedField.dataTypeId==dataTypeEnums.PROJECT){var randomFieldValue=Math.random().toString(36).substring(7),fieldInputElement;(fieldInputElement=$("<input></input>").attr("type","text")).addClass("searchForProject").addClass("select2-offscreen"),fieldInputElement.attr("id","searchForProject"),fieldInputElement.attr("name","searchForProject"),fieldInputElement.attr("title","Search for Project"),fieldInputElement.attr("requesttypefieldid",requestTypeField.requestTypeFieldId),fieldInputElement.attr("fieldid",randomFieldValue),fieldInputElement.attr("autogen",requestTypeField.autoGenerateProject),fieldInputElement.attr("bidirectionallink",requestTypeField.bidirectionalRequestLinking),"1"==requestTypeField.autoGenerateProject&&fieldInputElement.attr("disabled",!0)}else if(savedField.dataTypeId==dataTypeEnums.EXPERIMENT){var randomFieldValue=Math.random().toString(36).substring(7),fieldInputElement;(fieldInputElement=$("<input></input>").attr("type","text")).addClass("searchForExperement").addClass("select2-offscreen"),fieldInputElement.attr("id","searchForExperement"),fieldInputElement.attr("name","searchForExperement"),fieldInputElement.attr("title","Search for Experiment"),fieldInputElement.attr("requesttypefieldid",requestTypeField.requestTypeFieldId),fieldInputElement.attr("fieldid",randomFieldValue),fieldInputElement.attr("autogen",requestTypeField.autoGenerateExperement),fieldInputElement.attr("bidirectionallink",requestTypeField.bidirectionalRequestLinking),"1"==requestTypeField.autoGenerateExperement&&fieldInputElement.attr("disabled",!0)}else if(savedField.dataTypeId==dataTypeEnums.REGISTRATION||savedField.dataTypeId==dataTypeEnums.FOREIGN_LINK){var fieldInputElement;(fieldInputElement=requestTypeRegLinkGenerator(savedField,requestFieldValue.textValue)).attr("name",savedField.displayName),fieldInputElement.attr("title",savedField.hoverText),fieldInputElement.attr("requesttypefieldid",requestTypeField.requestTypeFieldId)}else if(savedField.dataTypeId==dataTypeEnums.REQUEST){var fieldInputElement;(fieldInputElement=$("<a></a>")).addClass("searchForRequests").addClass("btn").addClass("btn-info").addClass("btn-sm"),fieldInputElement.attr("id","searchForRequests"),fieldInputElement.attr("name",savedField.displayName),fieldInputElement.attr("title",savedField.hoverText),fieldInputElement.attr("requesttypefieldid",requestTypeField.requestTypeFieldId),fieldInputElement.text("No link.")}else if(savedField.dataTypeId==dataTypeEnums.UNIQUE_ID){console.warn("we are in the new dt!");var fieldInputElement=requestAutoGeneratedField(requestFieldValue.textValue)}else if(savedField.dataTypeId==dataTypeEnums.BIOSPIN_EDITOR){var fieldInputElement;ajaxModule().loadBioEditorComponent(),(fieldInputElement=$('<a/ href="javascript:void(0)">')).append("<img style='height: 300px; width:300px' src='js/bio-editor.jpg'/>"),fieldInputElement.attr("id",savedField.id),fieldInputElement.attr("name",savedField.displayName),fieldInputElement.css("min-height","100px"),fieldInputElement.css("min-width","100px"),fieldInputElement.css("cursor","pointer"),utilities().getBioEditorId(requestFieldValue?requestFieldValue.textValue:"",requestTypeField.requestTypeFieldId,utilities().isReadOnly(requestTypeField,savedRequestField)).then((function(editorId){fieldInputElement.attr("expId",editorId),editorId&&utilities().waitForBioInterCom((function(){window.BioInterCom.props.getEditorImg(editorId,jwt,"sequence").then((function(response){200==response.status?(fieldInputElement.empty(),fieldInputElement.append(response.data)):console.error("Bad Response from bio service.")}))}))})),fieldInputElement.on("click",(function(){window.BioInterCom&&window.BioInterCom.props.openBioEditor(jwt,globalUserInfo.companyId,globalUserInfo.userId,savedField.displayName,fieldInputElement.attr("expId"),utilities().isReadOnly(requestTypeField,savedRequestField),(function(newId){fieldInputElement.attr("expId",newId),window.BioInterCom.props.getEditorImg(newId,jwt,"sequence").then((function(response){200==response.status?(fieldInputElement.empty(),fieldInputElement.append(response.data)):console.error("Bad Response from bio service.")}))}),(function(expId){utilities().showUnsavedChangesNotification(fieldInputElement),"ELN"==currApp&&window.parent.sendAutoSave(requestTypeField.requestTypeFieldId,expId)}))}))}else alert("Error adding request editor field."),console.error("Error adding request editor field with data type: "+String(savedField.dataTypeId));Promise.all(fieldPromises).then((async function(){var editorFieldInputContainerElement=$('<div class="editorFieldInputContainer"></div>');if(requestFieldValue)if(savedField.dataTypeId==dataTypeEnums.FILE_ATTACHMENT)requestFieldValue.fileId&&(fieldInputElement.attr("fileid",requestFieldValue.fileId),fieldInputElement.find(".currentFileLink").text("Current file: "+requestFieldValue.fileName).attr("href","getSourceFile.asp?fileId="+requestFieldValue.fileId));else if(7==savedField.dataTypeId);else if(8==savedField.dataTypeId)fieldInputElement.val(requestFieldValue.textValue);else if(11==savedField.dataTypeId||12==savedField.dataTypeId){if(null==requestFieldValue.collaboratorName&&(requestFieldValue.collaboratorName="-- Make a Selection --"),usersList.length>0&&null!=requestFieldValue.dropDownValue){var user=usersList.find(x=>x.id==requestFieldValue.dropDownValue);requestFieldValue.collaboratorName=user?user.fullName:"Disabled User"}else requestFieldValue.collaboratorName="-- Make a Selection --";requestFieldValue.dropDownValue&&($(fieldInputElement).append(`<option value="${requestFieldValue.dropDownValue}">${requestFieldValue.collaboratorName}</option>`),fieldInputElement.find(`option[value='${requestFieldValue.dropDownValue}']`).prop("selected",!0))}else if(savedField.dataTypeId==dataTypeEnums.NOTEBOOK){const linkList=await getLinkDataForField(requestFieldValue.intValue,applicationEnum.NOTEBOOK,$(fieldInputElement).attr("fieldId")),optList=convertFieldLinkToSelect2Option(linkList,$(fieldInputElement).attr("fieldId"));var link;if(optList.forEach(linkOpt=>$(editorFieldInputContainerElement).append(linkOpt)),window.top.linkData)if(link=window.top.linkData.find(x=>x.linkSvcId==requestFieldValue.intValue)){var noteText=link.linkName?link.linkName:"",opt=$('<option style="display:none;" fieldId = "'+$(fieldInputElement).attr("fieldId")+'" id="'+link.objectId+'" selected="selected">'+noteText+"</option>");$(editorFieldInputContainerElement).append(opt)}}else if(savedField.dataTypeId==dataTypeEnums.PROJECT){const linkList=await getLinkDataForField(requestFieldValue.intValue,applicationEnum.PROJECT,$(fieldInputElement).attr("fieldId")),optList=convertFieldLinkToSelect2Option(linkList,$(fieldInputElement).attr("fieldId"));var link;if(optList.forEach(linkOpt=>$(editorFieldInputContainerElement).append(linkOpt)),window.top.linkData)if(link=window.top.linkData.find(x=>x.linkSvcId==requestFieldValue.intValue)){var projText=link.linkName?link.linkName:"",opt=$('<option style="display:none;" fieldId = "'+$(fieldInputElement).attr("fieldId")+'" id="'+link.objectId+'" selected="selected">'+projText+"</option>");$(editorFieldInputContainerElement).append(opt)}}else if(savedField.dataTypeId==dataTypeEnums.EXPERIMENT){const linkList=await getLinkDataForField(requestFieldValue.intValue,applicationEnum.EXPERIMENT,$(fieldInputElement).attr("fieldId")),optList=convertFieldLinkToSelect2Option(linkList,$(fieldInputElement).attr("fieldId"));var link;if(optList.forEach(linkOpt=>$(editorFieldInputContainerElement).append(linkOpt)),window.top.linkData)if(link=window.top.linkData.find(x=>x.linkSvcId==requestFieldValue.intValue)){var expText=link.linkName?link.linkName:"",opt=$('<option style="display:none;" fieldId = "'+$(fieldInputElement).attr("fieldId")+'" id="'+link.linkId+'" index="'+link.abr+'" selected="selected">'+expText+"</option>");$(editorFieldInputContainerElement).append(opt)}}else if(savedField.dataTypeId==dataTypeEnums.REQUEST&&null!=requestFieldValue.textValue){var data=JSON.parse(requestFieldValue.textValue);$.each(data,(function(key,data){fieldInputElement.attr("reqid",key),fieldInputElement.text(data)}))}$(".requestEditorContainer.newRequestEditor").length<1&&requestTypeField.restrictAccess&&!requestTypeField.canEdit&&savedRequestField&&fieldInputElement.prop("disabled",!0);var isOldRevision="undefined"!=typeof requestRevId&&""!=requestRevId,canWrite=!0;window.self!=window.top&&(canWrite=window.parent.canWrite),!isOldRevision&&canWrite||fieldInputElement.prop("disabled","disabled"),console.log(fieldInputElement);var removeEditorFieldInputButton=$('<button class="removeEditorFieldInputButton btn btn-danger btn-sm">Remove Value</button>'),addEditorFieldInputButton=$('<button class="addEditorFieldInputButton btn btn-success btn-sm">New Value</button>'),editorFieldValidationErrorLabel=$('<label class="editorFieldValidationErrorLabel"></label>'),navlink=$('<button class="navigateLink btn btn-info btn-sm" style="display:none">Open Notebook</button>'),clearlink=$('<button href="JavaScript:void(0);" class="clearLink btn btn-danger btn-sm" style="display:none">Clear</button>');if(savedRequestField&&editorFieldInputContainerElement.addClass("existingEditorFieldInputContainer"),editorFieldInputContainerElement.append(fieldInputElement),!isOldRevision&&canWrite&&savedField.dataTypeId!=dataTypeEnums.REQUEST&&editorFieldInputContainerElement.append(removeEditorFieldInputButton,addEditorFieldInputButton),savedField.dataTypeId==dataTypeEnums.FILE_ATTACHMENT&&requestTypeField.sendToELN){var moveFilesToELNBtn=$("<button>").addClass("moveFilesBtn").addClass("btn").addClass("btn-sm").text("Send to ELN");editorFieldInputContainerElement.append(moveFilesToELNBtn)}13!=savedField.dataTypeId&&14!=savedField.dataTypeId&&15!=savedField.dataTypeId||($(navlink).attr("fieldId",$(editorFieldInputContainerElement).children().attr("fieldId")),$(clearlink).attr("fieldId",$(editorFieldInputContainerElement).children().attr("fieldId")),14==savedField.dataTypeId?$(navlink).text("Open Project"):15==savedField.dataTypeId&&$(navlink).text("Open Experiment"),editorFieldInputContainerElement.append(navlink),editorFieldInputContainerElement.append(clearlink)),editorFieldInputContainerElement.append(editorFieldValidationErrorLabel);var inputElm="input";savedField.dataTypeId==dataTypeEnums.DROP_DOWN&&(inputElm="select"),utilities().permCheck(requestTypeField,editorFieldInputContainerElement,editorFieldInputContainerElement,inputElm),resolve(editorFieldInputContainerElement)}))}))},getLinkDataForField=async function(linkId,targetCd){let decodedLinksList=[];if(linkId){const fieldLinkResp=await ajaxModule().getLinkById(linkId),fieldLink=utilities().decodeServiceResponce(fieldLinkResp);fieldLink&&(decodedLinksList=await ajaxModule().decodeLink([fieldLink],targetCd))}return decodedLinksList},convertFieldLinkToSelect2Option=function(decodedLinksList,fieldId){return decodedLinksList.map(link=>$("<option>").attr("fieldId",fieldId).attr("id",link.linkId).attr("selected","selected").prop("selected","selected").attr("index",link.abr).text(link.linkName))},checkExistingCoAuthors=function(coAuthId){var returnVal=!1;return $.each($(".editorField[dataTypeId='12']").children(".editorFieldInputContainer"),(function(coauthIndex,coauthDiv){$.each($(coauthDiv).children(".editorFieldDropdown"),(function(dropdownIndex,dropdown){$(dropdown).val()==coAuthId&&(returnVal=!0)}))})),returnVal},getExistingCoAuthors=function(){var returnArr=[];return $.each($(".editorField[dataTypeId='12']").children(".editorFieldInputContainer"),(function(coauthIndex,coauthDiv){$.each($(coauthDiv).children(".editorFieldDropdown"),(function(dropdownIndex,dropdown){var dropdownId=$(dropdown).val();if(""!=dropdownId&&null!=dropdownId&&"null"!=dropdownId&&null!=dropdownId){var dropdownText,userObj={name:$(dropdown).find(`[value=${dropdownId}]`)[0].text,id:dropdownId};returnArr.push(userObj)}}))})),returnArr},calculateUserDropdown=function(dropdown,userList){var existingVal=$(dropdown).val();$(dropdown).empty(),$(dropdown).append('<option value="" selected emptyDefaultOption>-- Make a Selection --</option>'),userList=userList.map((function(u){return void 0===u.name&&(u.name=u.fullName),u})),$.each(userList,(function(dropdownOptionIndex,dropdownOption){if(!checkExistingCoAuthors(dropdownOption.id)){var option=$("<option></option>").attr("value",dropdownOption.id).text(dropdownOption.name);window.top!=window.self?dropdownOption.id!=window.parent.ownerId&&$(dropdown).append(option):$(dropdown).append(option)}})),utilities().sortDropdownlist($(dropdown)),$(dropdown).val(existingVal)},requestField_add=function(buttonElement,requestId,thisRequestType,canReprioritize,versionedRequestItems,versionedFields,userClick=!1){var wholeEditorField=buttonElement.parent().parent(),thisSavedFieldId=parseInt(wholeEditorField.attr("savedfieldid")),thisFieldInput=buttonElement.parent();$.each(versionedFields,(function(savedFieldIndex,savedField){if(savedField.id==thisSavedFieldId)var thisRequestTypeField=thisRequestType.fields.find(x=>x.savedFieldId==savedField.id),thisFieldInputPromise=new Promise((function(resolve,reject){if(userClick&&void 0!==wholeEditorField.attr("fieldgroup")&&""!==wholeEditorField.attr("fieldgroup")){var fieldMissingAllowMultiple=!1,fieldMissingCanAdd=!1;if($.each(wholeEditorField.siblings('.editorField[fieldgroup="'+wholeEditorField.attr("fieldgroup")+'"]'),(function(){"1"!==$(this).attr("allowmultiple")&&(fieldMissingAllowMultiple=!0),$(this).hasClass("noCanAdd")&&(fieldMissingCanAdd=!0)})),fieldMissingAllowMultiple||fieldMissingCanAdd){if(fieldMissingAllowMultiple)var notifyTitle="Error adding values to field group: Not all fields in group allow multiple values.";else var notifyTitle="Error adding values to field group: Insufficient permissions to add values to all fields in group.";$.notify({title:notifyTitle,message:""},{delay:5e3,type:"danger"})}else requestField_add(wholeEditorField.find(".editorFieldInputContainer:last-of-type .addEditorFieldInputButton"),requestId,thisRequestType,canReprioritize,versionedRequestItems,versionedFields,userClick=!1),$.each(wholeEditorField.siblings('.editorField[fieldgroup="'+wholeEditorField.attr("fieldgroup")+'"]'),(function(){var buttonElement=$(this).find(".editorFieldInputContainer:last-of-type .addEditorFieldInputButton");requestField_add(buttonElement,requestId,thisRequestType,canReprioritize,versionedRequestItems,versionedFields,userClick=!1)}));resolve(!0)}else addRequestEditorField(savedField,savedRequestField=void 0,thisRequestTypeField,requestId,canReprioritize).then((function(fieldInputElementContainer){thisFieldInput.after(fieldInputElementContainer),requestFieldHelper().initAllSealectFields(versionedRequestItems,versionedFields),resolve(!0)}))})).then((function(){thisFieldInput.next().find("input[type='text'], select").focus()}))}))},requestField_remove=function(buttonElement,userClick=!1){var wholeEditorField=buttonElement.parent().parent(),thisFieldInput=buttonElement.parent();if(userClick&&void 0!==wholeEditorField.attr("fieldgroup")&&""!==wholeEditorField.attr("fieldgroup")){var fieldMissingAllowMultiple=!1,fieldMissingCanDelete=!1;if($.each(wholeEditorField.siblings('.editorField[fieldgroup="'+wholeEditorField.attr("fieldgroup")+'"]'),(function(){"1"!==$(this).attr("allowmultiple")&&(fieldMissingAllowMultiple=!0),$(this).hasClass("noCanDelete")&&$(this).find(".editorFieldInputContainer:last-of-type").hasClass("existingEditorFieldInputContainer")&&(fieldMissingCanDelete=!0)})),fieldMissingAllowMultiple||fieldMissingCanDelete){if(fieldMissingAllowMultiple)var notifyTitle="Error removing values from field group: Not all fields in group allow multiple values.";else var notifyTitle="Error removing values from field group: Insufficient permissions to remove values from all fields in group.";$.notify({title:notifyTitle,message:""},{delay:5e3,type:"danger"})}else $.each(wholeEditorField.siblings('.editorField[fieldgroup="'+wholeEditorField.attr("fieldgroup")+'"]').find(".editorFieldInputContainer:last-of-type"),(function(){$(this).remove()})),wholeEditorField.find(".editorFieldInputContainer:last-of-type").remove()}else buttonElement.parent().remove()},displayCommentBox=function(savedFieldId,displayName){$("#commentsModal").attr("savedFieldId",savedFieldId),$("#commentsModal").attr("dispName",displayName),$("#commentsModal").find("h3").text("Comments for: ").append($("<div>").addClass("modal-title").text(displayName)),$("#comment-body").empty(),$.ajax({type:"POST",url:"getRequestComments.asp",data:{expId:window.parent.id,expType:5,reqField:savedFieldId}}).done((function(response){var comments=response.split("|||||");comments.pop(),$.each(comments,(function(index,comment){var commentList=comment.split(",,,,,"),user=commentList[0],date=commentList[1],text=window.top.decodeDoubleByteString(commentList[2]),commentDiv=$("<div>").addClass("comment"),userDiv=$("<h4>").addClass("modal-title").text(user),dateDiv=$("<sub>").addClass("modal-title").text(date),textDiv=$("<div>").addClass("comment-body").text(text);commentDiv.append(userDiv).append(dateDiv).append(textDiv),$("#comment-body").append(commentDiv)}))})),$("#commentsModal").modal("show"),$("#commentsModal").click((function(ev){ev.target==this&&$("#commentsModal").modal("hide")}))},submitComment=function(){var savedFieldId=$("#commentsModal").attr("savedFieldId"),displayName=$("#commentsModal").attr("dispName"),commentBody=$("#comment-field").val(),commentUrl="../experiments/add-comment.asp";commentUrl+="?experimentId="+window.parent.id,commentUrl+="&experimentType=5",commentUrl+="&parentCommentId=0",commentUrl+="&comment="+commentBody,commentUrl+="&r="+savedFieldId,$.ajax({type:"GET",url:commentUrl}).done((function(){$("#comment-field").val(""),fetchNumComments(savedFieldId),displayCommentBox(savedFieldId,displayName)}))},fetchNumComments=function(savedFieldId){$.ajax({type:"POST",url:"getRequestComments.asp",data:{expId:window.parent.id,expType:5,reqField:savedFieldId}}).done((function(response){console.log(response);var comments=response.split("|||||");comments.pop();var commentCount=$("span[requestfieldid='"+savedFieldId+"']");commentCount.text(comments.length),comments.length>0&&commentCount.removeClass("noComment")}))},bindStructures,removeProgressClasses=function(uploadBar){uploadBar.removeClass("myBar-upload"),uploadBar.removeClass("myBar-pause"),uploadBar.removeClass("myBar-success"),uploadBar.removeClass("myBar-error")},populateUserDropdown=function(userList,fieldInputElement){return new Promise((function(resolve,reject){var existingCollabs=getExistingCoAuthors();$.each(existingCollabs,(function(i,collab){0==userList.filter(x=>x.id==collab.id).length&&userList.push(collab)})),calculateUserDropdown(fieldInputElement,userList),$(fieldInputElement).focus(()=>calculateUserDropdown(fieldInputElement[0],userList)),resolve(!0)}))},documentReadyFunction,createTextInput=function(className,value){var textInput=$('<input type="text">').attr("value",value);return textInput.addClass(className),textInput},createLongTextInput=function(className,value){return null==value&&(value=""),$(`<textarea>${value}</textarea>`).addClass(className)},createIntegerInput=function(className,value){return isNaN(parseInt(value))?$("<input type='number'>").addClass(className):$("<input type='number'>").addClass(className).attr("value",value)},createRealNumberInput=function(className,value){return $("<input type='number' step='0.1'>").addClass(className).attr("value",value)},createDropDownSelectInput=function(className,field,requestTypeField,value,requestId,canReprioritize){null==value&&(value="");var dropdownInput=$("<select>").addClass(className),emptyInput=createDropDownOption("","-- Make a Selection --");dropdownInput.append(emptyInput),$.each(field.options,(function(i,option){if(1!=option.disabled){var thisOption=createDropDownOption(option.dropdownOptionId,option.displayName);if(requestId){var disabledFilterOption=!canReprioritize&&utilities().hasQueueableOption(requestTypeField.requestTypeFieldPriorityOptions);disabledFilterOption&&(disabledFilterOption=option.dropdownOptionId!=value),thisOption.attr("disabled",disabledFilterOption)}dropdownInput.append(thisOption)}})),utilities().sortDropdownlist(dropdownInput),dropdownInput.find(`option[value="${value}"]`).prop("selected","selected"),dropdownInput.find(`option[value="${value}"]`).attr("selected",!0);var queueableOptionIds=requestTypeField.requestTypeFieldPriorityOptions?requestTypeField.requestTypeFieldPriorityOptions.filter(x=>x.queueable).map(x=>x.dropDownOptionId):[],reprioritizingRequest=!requestId&&(canReprioritize&&queueableOptionIds.includes(value));return dropdownInput.attr("reprioritizingRequest",reprioritizingRequest),dropdownInput.on("change",(function(){var selectedValue=parseInt($(this).find("option:selected").val()),reprioritizingRequest=canReprioritize&&queueableOptionIds.includes(selectedValue)&&!(queueableOptionIds.includes(value)&&requestId);$(this).attr("reprioritizingRequest",reprioritizingRequest)})),dropdownInput},createDropDownOption=function(value,text){return $("<option>").val(value).text(text)},createStructureInput=function(className,requestItemTypeFieldId,value){return $("<div>").addClass(className).attr("requestitemtypefieldid",requestItemTypeFieldId)},createDateInput=function(className,value){var fieldInputElement=$('<input type="text">').addClass(className).attr("value",value).attr("initVal",value);if(pikadaySettingsObject={firstDay:1,minDate:new Date(1990,0,1),maxDate:new Date(2040,12,31),yearRange:[1990,2040],format:"MM/DD/YYYY"},value){var previousValueFormatted=moment.utc(value).format("MM/DD/YYYY");pikadaySettingsObject.defaultDate=moment(previousValueFormatted).toDate(),pikadaySettingsObject.setDefaultDate=!0;var picker=fieldInputElement.pikaday(pikadaySettingsObject)}else var picker=fieldInputElement.pikaday(pikadaySettingsObject);return picker},createRegLink=function(savedField,value){var color="btn-info",foreignLink="";[dataTypeEnums.FOREIGN_LINK].includes(savedField.dataTypeId)&&(color="btn-success",foreignLink="foreignLinkBtn");var className=`btn btn-sm ${color} ${foreignLink}`,linkText=value,linkVal=value,linkHref="javascript:void(0)",regLink;return""!=value&&null!=value?-1==value?linkText="New Compound":savedField.dataTypeId==dataTypeEnums.REGISTRATION&&(linkHref=`/arxlab/registration/showReg.asp?regNumber=${value}`):linkText="No link",$("<a>").addClass(className).text(linkText).val(linkVal).attr("target","_blank").attr("href",linkHref)},createAutoGeneratedField=function(className,value){var randomId=Math.random().toString(36).substring(2);let textInput=$(`<input id=${randomId} disabled type="text">`).attr("value",value||""),btn=$(`<button" onclick="utilities().copyFnc('${randomId}')"class="navigateLink btn btn-info btn-sm">Copy</button>`);textInput.addClass(className);let retField=$("<div>").append(textInput);return value&&retField.append(btn),retField},requestTypeTextGenerator=function(value){return createTextInput("editorFieldInput",value)},requestItemTypeTextGenerator,requestTypeLongTextGenerator=function(value){return createLongTextInput("editorFieldInput",value)},requestItemTypeLongTextGenerator,requestTypeIntGenerator=function(value){return createIntegerInput("editorFieldInput",value)},requestItemTypeIntGenerator,requestTypeNumberGenerator=function(value){return createRealNumberInput("editorFieldInput",value)},requestItemTypeNumberGenerator,requestTypeDropdownGenerator=function(field,requestTypeField,value,requestId,canReprioritize){return createDropDownSelectInput("editorFieldDropdown requestFieldDropdown",field,requestTypeField,value,requestId,canReprioritize)},requestItemTypeDropdownGenerator,requestTypeStructureGenerator,requestTypeDateGenerator=function(value){return createDateInput("editorFieldInput",value)},requestItemTypeDateGenerator,requestTypeCKEditorGenerator=function(ckeId,value){var ckeditorInput=createLongTextInput("editorFieldInput ckEditorField",value);return ckeditorInput.attr("id",ckeId),ckeditorInput},requestTypeRegLinkGenerator=function(savedField,value){return createRegLink(savedField,value)},requestItemTypeRegLinkGenerator,requestAutoGeneratedField=function(value){return createAutoGeneratedField("editorFieldInput",value)};return{makeNewEditorField:makeNewEditorField,fetchNumComments:fetchNumComments,displayCommentBox:displayCommentBox,bindStructures:function(requestType,versionedRequestItems,versionedFields){var doRegSearchOnSubmit=requestType.searchRegForExistingCompound;return new Promise((function(resolve,reject){var fieldsInRequest=$(".editorSection > .editorField");$.each(fieldsInRequest,(function(index,item){if(8==$(item).attr("datatypeid")){console.log(item);var structureHolder=$(item).children()[1];structureHolder=$(structureHolder).children()[0];var structureId="Field_"+index+"_"+$(structureHolder).attr("requestitemtypefieldid");if("undefined"!=typeof thisRequest)var startingMolData=thisRequest.requestFields[index].values[0].structureMolData_hidden;else var startingMolData="";var readOnlyStructure=!1,callBack;console.log(structureId),getChemistryEditorMarkup(structureId,"",startingMolData,280,140,!1,(function(){utilities().autoFillRequestField(structureId,!1,versionedRequestItems,versionedFields),doRegSearchOnSubmit&&(utilities().searchRegForStructure(structureId,versionedRequestItems,versionedFields),utilities().searchForeignReg(structureId,versionedRequestItems,versionedFields)),$(`[liveEditId="${structureImageId}"]`).closest("div.editorField").attr("dirty",!0)}),null,null,null,null,null,!0).then((function(structureEditorHtml){$(structureHolder).html(structureEditorHtml)})),"repeatRequest"==window.CurrentPageMode&&utilities().autoFillRequestField(structureId,!0,versionedRequestItems,versionedFields),utilities().searchForeignReg(structureId)}})),resolve(!0)}))},requestField_add:requestField_add,getLinkDataForField:getLinkDataForField,documentReadyFunction:function(){$("body").on("click","button.removeEditorFieldInputButton",(function(event){requestField_remove($(this),userClick=!0),utilities().showUnsavedChangesNotification()})),$("body").on("click","button.comment-submit",(function(event){submitComment()}))},requestItemTypeLongTextGenerator:function(value){return createLongTextInput("dataTableCellTextarea",value)},requestItemTypeDropdownGenerator:function(field,requestItemTypeField,value){return createDropDownSelectInput("dataTableCellDropdown",field,requestItemTypeField,value,null,null)},requestTypeTextGenerator:requestTypeTextGenerator,requestItemTypeTextGenerator:function(value){return createTextInput("dataTableCellTextInput",value)},requestTypeStructureGenerator:function(requestItemTypeFieldId,value){return createStructureInput("structureDisplay",requestItemTypeFieldId,value)},requestItemTypeIntGenerator:function(value){return createIntegerInput("dataTableCellTextInput",value)},requestItemTypeNumberGenerator:function(value){return createRealNumberInput("dataTableCellTextInput",value)},requestItemTypeRegLinkGenerator:function(savedField,value){return createRegLink(savedField,value)},requestItemTypeDateGenerator:function(value){return createDateInput("dataTableCellDateInput",value)},requestAutoGeneratedField:requestAutoGeneratedField}},fieldsModuleHelper=fieldsModule();$(document).ready((function(){fieldsModuleHelper.documentReadyFunction()}));
//# sourceMappingURL=fieldsModule.min.js.map