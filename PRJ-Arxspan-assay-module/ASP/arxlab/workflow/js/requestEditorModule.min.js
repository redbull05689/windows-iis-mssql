requestEditorModule=function(){var populateRequestFieldsSection=function(requestType,selectorString=".editorSection[sectionid='requestFields']",savedRequest,canReprioritize,versionedFields,versionedRequestItems){return new Promise((function(resolve,reject){console.log("!!!!!!!!!!!!!!!!!!!!! populateRequestFieldsSection !!!!!!!!!!!!!!!!!!!!!!!!!"),console.log(requestType),console.log(savedRequest),console.log(selectorString);var requestId=null;savedRequest&&"repeatRequest"!=CurrentPageMode&&(requestId=savedRequest.id),populateUserGroupsList().then((function(){var populateRequestFieldsSectionInterval=window.setInterval((function(){console.log("looking for selectorString: ",selectorString),0!=$(selectorString).length&&void 0!==versionedFields&&(console.log("ok, found it"),window.clearInterval(populateRequestFieldsSectionInterval),populateRequestFieldsSectionImpl(requestType,selectorString,savedRequest,canReprioritize,versionedFields).then((function(){var bindPromises=[];bindPromises.push(fieldsModuleHelper.bindStructures(requestType,versionedRequestItems,versionedFields)),Promise.all(bindPromises).then((function(){var anyFields=requestType.fieldsDict.sortOrder.map(x=>requestType.fieldsDict[x][0].disabled).length>0;fieldsReady=!anyFields||$(".editorFieldInputContainer").length,window.location.href.toLowerCase().includes("makenewrequest")||window.setTimeout((function(){fieldsReady&&finalizeRequestEditorInitialization().then((function(){$("#basicLoadingModal").modal("hide")}))})),resolve(!0)}))})),$("body").off("click","button.addEditorFieldInputButton"),$("body").on("click","button.addEditorFieldInputButton",(function(event){fieldsModule().requestField_add($(this),requestId,requestType,canReprioritize,versionedRequestItems,versionedFields,userClick=!0),utilities().showUnsavedChangesNotification()})),$("body").off("click","button.moveFilesBtn"),$("body").on("click","button.moveFilesBtn",(function(event){let fileForms=$(event.target.parentElement.parentElement).find("form"),fileList=[];$.each(fileForms,(function(i,f){let fileId=$(f).attr("fileid");if(fileId&&fileId>-1){let fileName,file={id:fileId,name:$(f).find(".currentFileLink").text()};fileList.push(file)}})),fileList.length>0?(populateMoveFilesModal(fileList),$("#moveFilesModal").modal("show")):swal("No files to send!")})),$("body").off("click","button.cancel-send-btn"),$("body").on("click","button.cancel-send-btn",(function(event){$("#moveFilesModal").modal("hide")})),$("body").off("click","button.send-file-submit-btn"),$("body").on("click","button.send-file-submit-btn",(function(event){submitFileMoveBtnClick()})))}))}))}))};let populateMoveFilesModal=function(fileList){$("#workflowFileExperimentSearch").select2("data",null);let fileSection=$("#moveFilesSelectorSection");fileSection.empty(),fileList.forEach((function(file){let checkboxDiv=$("<div>").addClass("fileImportRadioButton"),fileCheckbox=$("<input>").attr("type","checkbox").addClass("defaultSettingButton").attr("id",`sendFile_${file.id}`).val(file.id),fileLabel=$("<label>").attr("for",`sendFile_${file.id}`).addClass("defaultSettingLabel").text(file.name);1==fileList.length&&fileCheckbox.prop("checked",!0).prop("disabled",!0),checkboxDiv.append(fileCheckbox,fileLabel),fileSection.append(checkboxDiv)}))},submitFileMoveBtnClick=function(){let errorMsg="",selectedFilesList=$("#moveFilesSelectorSection").find(":checked"),numFiles=selectedFilesList.length;0==numFiles&&(errorMsg="No files selected.");let expData=$("#workflowFileExperimentSearch").select2("data");if(expData||(errorMsg="No experiment selected."),""!=errorMsg)return void window.top.swal("error",errorMsg,"warning");$("#moveFilesModal").modal("hide"),$("#basicLoadingModal").modal("show");let expId=expData.id,expTypeId=expData.type,expOwnerId=expData.owner,fileIdList,attachmentPromiseList=selectedFilesList.map((arrayIndex,fileCheckbox)=>$(fileCheckbox).val()).toArray().map(fileId=>ajaxModule().sendFileToELNExperiment(fileId,expId,expTypeId,expOwnerId));Promise.all(attachmentPromiseList).then((function(resArr){$("#basicLoadingModal").modal("hide");let failedRespList=resArr.filter(x=>"Success!"!=x);if(0==failedRespList.length)ajaxModule().setExperimentDraft(expId,expTypeId).then((function(draftRes){let multipleFileStr=numFiles>1?"s have":" has";window.top.swal({title:"Success!",type:"success",text:`Your attachment${multipleFileStr} been copied and a new draft has been created.`,showCancelButton:!0,cancelButtonText:"OK",confirmButtonText:"Go to experiment"},(function(){requestFieldHelper().NavToExperement(expId,expData.index)}))}));else{let errorMsg="Error!";checkSendELNError(failedRespList,"writeError")?errorMsg="You do not have access to this experiment.":checkSendELNError(failedRespList,"draftError")?errorMsg="The experiment is locked by an active draft.":checkSendELNError(failedRespList,"fileExistsError")?errorMsg="File already exists for current draft.":checkSendELNError(failedRespList,"fileNonexistenceError")&&(errorMsg="File could not be found."),window.top.swal("Error",errorMsg,"warning")}}))};var checkSendELNError=function(respList,errorMsg){return respList.filter(resp=>resp==errorMsg).length>0},waitForFieldLoading=function(fieldId){return new Promise((function(resolve,reject){!function waitForFieldLoaded(fieldIdActual){if(result=$(`.editorField[requesttypefieldid=${fieldIdActual}]`),result.length>0)return resolve(result);setTimeout(waitForFieldLoaded.bind(null,fieldId),100)}(fieldId)}))},populateRequestFieldsSectionImpl=function(requestType,selectorString,savedRequest,canReprioritize,versionedFields){return new Promise((function(resolve,reject){if(window.duplicateRequestId&&!savedRequest&&!window.requestFieldsSectionPopulatedForDupRequest)return resolve(!1),!1;window.duplicateRequestId&&savedRequest&&(window.requestFieldsSectionPopulatedForDupRequest=!0),$(selectorString).empty();var fieldBuilderPromises=[];$.each(requestType.fieldsDict.sortOrder,(function(index,requestTypeFieldId){0==requestType.fields.find(x=>x.requestTypeFieldId==requestTypeFieldId).disabled&&fieldBuilderPromises.push(fieldsModuleHelper.makeNewEditorField(requestType,savedRequest,canReprioritize,requestTypeFieldId,versionedFields))}));var editorFieldPromises=[];Promise.all(fieldBuilderPromises).then((function(editorFields){$.each(editorFields,(function(editorFieldIndex,editorField){editorField&&($(selectorString).append(editorField),editorFieldPromises.push(waitForFieldLoading(editorField.attr("requestTypeFieldId"))))})),Promise.all(editorFieldPromises).then((function(editorFields){$.each(editorFields,(function(editorFieldIndex,editorField){if(editorField&&window.self!=window.top&&null!=editorField.attr("requestfieldid")&&"6"!=window.parent.latestStatus){var fieldLabel=editorField.find(".fieldLabel"),fieldLabelText=$(fieldLabel).text(),numComments=$("<span></span>").attr("requestfieldid",editorField.attr("requestFieldId")).addClass("commentNotification").addClass("noComment");numComments.attr("title","Number of Comments"),fieldLabel.append(numComments),fieldsModuleHelper.fetchNumComments(editorField.attr("requestFieldId")),fieldLabel.on("click",(function(){fieldsModuleHelper.displayCommentBox(editorField.attr("requestFieldId"),fieldLabelText)}))}})),savedRequest?(console.log("-----------savedRequest----------------"),console.log(savedRequest),savedRequest.hasOwnProperty("coauthors")&&$.each(savedRequest.coauthors,(function(i,authorId){if(console.log("found: ",$(".editorField[datatypeid='12']").find('select option[value="'+authorId+'"]:selected')),hasCoAuthMadeEdits(authorId)){var theSelects=$(".editorField[datatypeid='12']").find('select option[value="'+authorId+'"]:selected').parent();$(theSelects).parent().find(".removeEditorFieldInputButton").css("display","none"),$(theSelects).attr("disabled","disabled")}})),1==requestType.restrictAccess&&0==requestType.canEdit&&$(selectorString).closest(".dropdownEditorContainer").find("input, select, button").prop("disabled",!0)):$.each($(".requestEditorContainer.newRequestEditor #requestFieldsEditorSection .editorField select:not([disabled])"),(function(){1==$(this).find("option:not([emptyDefaultOption])").length&&$(this).find("option:not([emptyDefaultOption])").prop("selected",!0)})),resolve(!0)}))}))}))},populateDraftVals=function(thisRequestType,versionedRequestItems,versionedFields){return new Promise((function(resolve,reject){var editorPromises=[];editorPromises.push(populateDraft(versionedRequestItems,versionedFields)),Promise.all(editorPromises).then((function(){console.log("EDITOR DONE"),window.parent.$("#submitRow").show(),requestEditorHelper.bindRichTextFields(versionedRequestItems,versionedFields).then((function(){if("custExp"==window.CurrentPageMode&&window.top.$("#requestFields").empty(),requestFieldHelper().applyDependencies(thisRequestType,versionedFields),"ELN"==window.top.currApp){window.parent.$("#basicLoadingModal").modal("hide"),utilities().resizeManageRequestsTable();try{window.parent.bindSaveShortcut()}catch(e){}}utilities().resizeCustExpIframe(),resolve(!0)}))}))}))},hasCoAuthMadeEdits=function(authorId){return"ELN"==window.top.currApp&&(0!=window.auditTrailAuthors.length?window.auditTrailAuthors.includes(authorId):void ajaxModule().fetchAuditTrailAuthors().then((function(){return window.auditTrailAuthors.includes(authorId)})))},notifyELNCollaborator=function(UID){if(!window.parent.coAuthors.includes(UID)){var Title="Experiment Collaborator",Note=`You have been added as a Collaborator on Experiment: <a href="${window.parent.location.href}">${window.top.$("#e_name").val()}</a>`,noteType=17;isNaN(UID)||($.ajax({type:"POST",url:"Notify.asp",async:!1,data:{UID:UID,Title:Title,Note:Note,noteType:17}}).done((function(response){console.log(response)})),null!=UID&&(window.parent.coAuthors+=","+UID.toString()))}},getRequestField=function(editorField,requestId=null){return new Promise((function(resolve,reject){var thisRequestField={requestTypeFieldId:parseInt($(editorField).attr("requesttypefieldid")),companyId:globalUserInfo.companyId,sortOrder:parseInt($(editorField).attr("sortorder"))};requestId&&(thisRequestField.requestId=requestId);var requestFieldsId=$(editorField).attr("requestfieldid");isNaN(requestFieldsId)||(thisRequestField.id=parseInt(requestFieldsId));var dataTypeId=parseInt($(editorField).attr("datatypeid")),requestFieldValuePromises=[];if($(editorField).find('select, input[type="text"], input[type="number"], textarea, form.requestFieldFileAttachmentForm').each((function(requestFieldValueIndex,requestFieldEditor){requestFieldValuePromises.push(fieldValuePromiseHelper(this,thisRequestField,dataTypeId,requestFieldValueIndex))})),requestFieldValuePromises.length>0)Promise.all(requestFieldValuePromises).then((function(requestFieldValues){thisRequestField.requestFieldValues=requestFieldValues.filter(x=>x),resolve(thisRequestField)}));else{var requestFieldValues=[];if(dataTypeId==dataTypeEnums.STRUCTURE){var editerDiv=$(editorField).children()[1],strDisplay=$(editerDiv).children().children().children()[1],strDataDiv=$(strDisplay).children(),liveEditId=$(strDataDiv).attr("liveeditid");(thisRequestFieldValue={}).sortOrder=1;var moldata=null;if(null==(moldata=allStructures[liveEditId])||null==moldata)var moldata=getEmptyMolFile();thisRequestFieldValue.structureDiagram=moldata,requestFieldValues.push(thisRequestFieldValue)}else if(dataTypeId==dataTypeEnums.REGISTRATION||dataTypeId==dataTypeEnums.FOREIGN_LINK){var aLink=$(editorField).find("a"),thisRequestFieldValue;(thisRequestFieldValue={}).textValue=aLink.val(),thisRequestFieldValue.sortOrder=1,requestFieldValues.push(thisRequestFieldValue)}else if(dataTypeId==dataTypeEnums.REQUEST){var aLink=$(editorField).find("a");$.each(aLink,(function(index,item){var thisRequestFieldValue={},valObj={},key=$(item).attr("reqid"),val=$(item).html();void 0===key&&(key=null),valObj[key]=val,thisRequestFieldValue.textValue=JSON.stringify(valObj),thisRequestFieldValue.sortOrder=index+1,requestFieldValues.push(thisRequestFieldValue)}))}else if(dataTypeId==dataTypeEnums.BIOSPIN_EDITOR){const aLink=$(editorField).find("a"),value=aLink.attr("expId");var thisRequestFieldValue;window.top!=window.self&&window.top.experimentJSON&&("bioEditorIds"in window.top.experimentJSON?window.top.experimentJSON.bioEditorIds.push(value):window.top.experimentJSON.bioEditorIds=[value]),(thisRequestFieldValue={}).textValue=value,thisRequestFieldValue.sortOrder=1,requestFieldValues.push(thisRequestFieldValue)}thisRequestField.requestFieldValues=requestFieldValues,resolve(thisRequestField)}}))},fieldValuePromiseHelper=function(editorField,thisRequestField,dataTypeId,requestFieldValueIndex){return new Promise((function(resolve,reject){var thisRequestFieldValue={companyId:globalUserInfo.companyId,sortOrder:requestFieldValueIndex+1};thisRequestField.id&&(thisRequestFieldValue.requestFieldsId=thisRequestField.id);var fieldValuePromiseList=[],keyToUse="textValue",fieldVal="";if(dataTypeId==dataTypeEnums.INTEGER)keyToUse="intValue",fieldVal=$(editorField).val();else if(dataTypeId==dataTypeEnums.REAL_NUMBER)keyToUse="realValue",fieldVal=$(editorField).val();else if([dataTypeEnums.DROP_DOWN,dataTypeEnums.USER_LIST,dataTypeEnums.CO_AUTHORS].includes(dataTypeId))keyToUse="dropDownValue",fieldVal=$(editorField).find("option:selected").attr("value"),fieldVal=isNaN(fieldVal)?null:parseInt(fieldVal),null!=window.top.thisRequestType&&dataTypeId==dataTypeEnums.CO_AUTHORS&&window.self!=window.top&&window.top.thisRequestType.notifyColabs&&notifyELNCollaborator(fieldVal);else if(dataTypeId==dataTypeEnums.FILE_ATTACHMENT){keyToUse="fileId";var fieldVal=$(editorField).attr("fileid");fieldVal=isNaN(fieldVal)?null:parseInt(fieldVal)}else if(dataTypeId==dataTypeEnums.DATE)keyToUse="dateValue",""!==(fieldVal=$(editorField).val())&&(fieldVal=new Date(1e3*moment.utc($(editorField).val(),"MM/DD/YYYY").unix()));else if(dataTypeId==dataTypeEnums.RICH_TEXT)fieldVal=(fieldVal=ckEditorInstances[$(editorField).attr("id")].getData()).replace(new RegExp("[​]","g"),""),fieldVal=utilities().encodeIt(fieldVal);else if([dataTypeEnums.NOTEBOOK,dataTypeEnums.PROJECT].includes(dataTypeId)){if(keyToUse="intValue",fieldVal=0,!["searchForNotebook","searchForProject"].includes($(editorField).attr("id")))return void resolve(null);var linkData;if(null!=(linkData=$(editorField).select2("data"))&&Object.keys(linkData).includes("id")){var linkTargetId=linkData.id;if(-1!=linkTargetId){var linkInput=utilities().makeLinkInputModel(linkTargetId,dataTypeId);thisRequestFieldValue.link=linkInput}}}else if(dataTypeId==dataTypeEnums.EXPERIMENT){if(keyToUse="intValue",fieldVal=0,"searchForExperement"!=$(editorField).attr("id"))return void resolve(null);var linkData;null!=(linkData=$(editorField).select2("data"))&&Object.keys(linkData).includes("id")&&fieldValuePromiseList.push(new Promise((function(resolve,reject){var experimentId=linkData.id,experimentTypeName=linkData.index;ajaxModule().getAllExperimentId(experimentId,experimentTypeName).then((function(linkTargetId){var link=utilities().makeLinkInputModel(linkTargetId,dataTypeId);thisRequestFieldValue.link=link,resolve(thisRequestFieldValue)}))})))}else fieldVal=$(editorField).val();Promise.all(fieldValuePromiseList).then(()=>{thisRequestFieldValue[keyToUse]=fieldVal,resolve(thisRequestFieldValue)})}))},checkIfAllTablesMeetMinRowCount=function(thisRequestType,editor){var returnBool=!0;return $.each(editor.find(".requestItemsEditor"),(function(requestItemEditorIndex,requestItemEditor){var tableMeetsReq;if(!checkIfTableMeetsMinRowCount(requestItemEditor,thisRequestType))return returnBool=!1,!1})),returnBool},checkIfTableMeetsMinRowCount=function(requestItemEditor,thisRequestType){var returnBool=!0,nameOfItemType="",minRowCount=0,sminRowCount=0,theTable=$(requestItemEditor).find("table.requestItemEditorTable:not(.DTFC_Cloned)");if("makeNewRequest"==window.CurrentPageMode){minRowCount=thisRequestType.requestItemTypes.find(x=>x.requestItemTypeId==$(theTable[1]).attr("requestitemtypeid")).requestItemMinimumCount;var numOfRows=theTable.DataTable().rows().length;if(1==numOfRows)var emptyRow=$($($(theTable[1]).children())[1]).children().children().hasClass("dataTables_empty");(minRowCount>numOfRows||1==minRowCount&&1==numOfRows&&emptyRow)&&(sminRowCount=minRowCount,nameOfItemType=thisRequestType.requestItemTypes.find(x=>x.requestItemTypeId==$(theTable[1]).attr("requestitemtypeid")).requestItemName,void 0!==window.upsertRequestNotification?window.upsertRequestNotification.update({title:`At least ${sminRowCount} row(s) required in ${nameOfItemType} table.`,message:"",type:"danger"}):window.upsertRequestNotification=$.notify({title:`At least ${sminRowCount} row(s) required in ${nameOfItemType} table.`,message:""},{delay:0,type:"danger",template:utilities().notifyJSTemplates.default,onClose:function(){window.upsertRequestNotification=void 0}}),returnBool=!1)}return returnBool},requestItemFieldValMapper=function(val,requestItemFieldDataTypeId){var fieldVal={companyId:globalUserInfo.companyId},keyToUse="textValue";if(dataTypeEnums.INTEGER==requestItemFieldDataTypeId)keyToUse="intValue";else if(dataTypeEnums.REAL_NUMBER==requestItemFieldDataTypeId)keyToUse="realValue";else if(dataTypeEnums.DROP_DOWN==requestItemFieldDataTypeId)keyToUse="dropDownValue";else if(dataTypeEnums.DATE==requestItemFieldDataTypeId){if(keyToUse="dateValue",null!=val&&""!=val){if("string"==typeof val)var date=new Date(val);else var date=new Date(1e3*val+60*(new Date).getTimezoneOffset()*1e3);val=`${date.getMonth()+1}/${date.getDate()}/${date.getFullYear()}`}}else dataTypeEnums.REQUEST==requestItemFieldDataTypeId&&(val=JSON.stringify(val));return fieldVal[keyToUse]=val,fieldVal},requestItemRowMapper=function(requestTypeColumn,thisRequestTypeColumns,thisRequestItem,rowIndex,rowData,requestId,thisRequestItemType,submitAllFields){return new Promise((function(resolve,reject){var requestTypeColumnIndex=thisRequestTypeColumns.indexOf(requestTypeColumn),requestItemTypeFieldId=requestTypeColumn.requestItemTypeFieldId;if(requestItemTypeFieldId){var thisRequestItemField={requestItemId:thisRequestItem.id,requestItemTypeFieldId:requestItemTypeFieldId,companyId:globalUserInfo.companyId,sortOrder:requestTypeColumnIndex},thisRequestItemFieldValues=[],thisRequestItemTypeField=thisRequestItemType.fields.find(x=>x.requestTypeFieldId==requestItemTypeFieldId);if(null!=requestTypeColumn.savedField&&thisRequestItemTypeField){var requestItemFieldDataTypeId=requestTypeColumn.savedField.dataTypeId,lowercaseFieldName=requestTypeColumn.data,fieldDisplayName=thisRequestItemTypeField.displayName;null==rowData[lowercaseFieldName]&&(Object.keys(rowData).includes(fieldDisplayName)?rowData[lowercaseFieldName]=rowData[fieldDisplayName]:rowData[lowercaseFieldName]={dirty:!1,data:[]});var valuesArray=rowData[lowercaseFieldName].data,isDirty,fetchData=rowData[lowercaseFieldName].dirty||submitAllFields||duplicatingRequest;if(requestId&&!fetchData&&requestItemFieldDataTypeId!=dataTypeEnums.STRUCTURE)return void resolve(null);var requestItemFieldPromises=[];if(requestItemFieldDataTypeId==dataTypeEnums.STRUCTURE){if(requestId&&!fetchData)return void resolve(null);molHasData(valuesArray[0])&&thisRequestItemFieldValues.push({companyId:globalUserInfo.companyId,structureDiagram:valuesArray[0]})}else if(requestItemFieldDataTypeId==dataTypeEnums.FILE_ATTACHMENT)thisRequestItemFieldValues=valuesArray.map((function(val){var fileId=-1,fieldVal;return val&&(fileId=val.id),{companyId:globalUserInfo.companyId,fileId:-1==fileId?null:fileId}}));else if([dataTypeEnums.NOTEBOOK,dataTypeEnums.PROJECT].includes(requestItemFieldDataTypeId)){if(0==valuesArray.length){var fieldVal={companyId:globalUserInfo.companyId,intValue:0};thisRequestItemFieldValues.push(fieldVal)}$.each(valuesArray,(function(itemFieldValueIndex,itemFieldValue){if(itemFieldValue){var linkJson,linkTargetId=JSON.parse(itemFieldValue).id,link=utilities().makeLinkInputModel(linkTargetId,requestItemFieldDataTypeId),fieldVal={companyId:globalUserInfo.companyId,intValue:0,link:link};thisRequestItemFieldValues.push(fieldVal)}else thisRequestItemFieldValues.push({companyId:globalUserInfo.companyId,intValue:0})}))}else if(requestItemFieldDataTypeId==dataTypeEnums.EXPERIMENT)requestItemFieldPromises.push(new Promise((function(resolve,reject){var allExpPromises=[];$.each(valuesArray,(function(itemFieldValueIndex,itemFieldValue){var linkJson=JSON.parse(itemFieldValue),experimentId=linkJson.id,experimentTypeName=linkJson.index;allExpPromises.push(ajaxModule().getAllExperimentId(experimentId,experimentTypeName))})),Promise.all(allExpPromises).then((function(allExpIds){$.each(allExpIds,(function(expIdIndex,linkTargetId){var link=utilities().makeLinkInputModel(linkTargetId,requestItemFieldDataTypeId),fieldVal={companyId:globalUserInfo.companyId,intValue:0,link:link};thisRequestItemFieldValues.push(fieldVal)})),resolve()}))})));else var thisRequestItemFieldValues=valuesArray.map(val=>requestItemFieldValMapper(val,requestItemFieldDataTypeId));Promise.all(requestItemFieldPromises).then((function(){thisRequestItemField.requestItemFieldValues=thisRequestItemFieldValues,resolve(thisRequestItemField)}))}else resolve(null)}else resolve(null)}))},packageRequest=function(requestId,thisRequestType,editor,submitAllFields,versionedRequestItems){return new Promise((function(resolve,reject){var requestJson={};requestJson.companyId=globalUserInfo.companyId,requestJson.requestorId=globalUserInfo.userId,requestJson.requestTypeId=thisRequestType.id;var dirtyDataSelector="";requestId?"undefined"!=typeof duplicatingRequest&&duplicatingRequest||(requestJson.id=requestId,submitAllFields||(dirtyDataSelector='[dirty="true"]')):window.self!=window.top&&""!=window.parent.$("#requestId").val()&&(requestJson.id=window.parent.$("#requestId").val(),submitAllFields||(dirtyDataSelector='[dirty="true"]'));var hasGroupSelector,groupSelectDropdownStr,groupSelector=`[fieldid="assignedUserGroup"]${editor.find('[fieldid="assignedUserGroup"] select#assignedUserGroupDropdown').length>0?" select#assignedUserGroupDropdown option:selected":""}`,assignedGroupId=parseInt(editor.find(groupSelector).attr("groupId"));requestJson.assignedGroupId=parseInt(assignedGroupId);var requestFieldPromises=[];requestFields=[],$.each(editor.find(`.editorSection[sectionid="requestFields"] > .editorField${dirtyDataSelector}`),(function(requestTypeFieldIndex,editorField){requestFieldPromises.push(getRequestField(editorField,requestJson.id))})),Promise.all(requestFieldPromises).then((function(requestFieldsArr){requestJson.requestFields=requestFieldsArr,requestJson.requestItems=[];var requestItemPromises=[];$.each(editor.find(".requestItemsEditor"),(function(requestItemEditorIndex,requestItemEditor){requestItemPromises.push(requestItemPromiseHelper(requestItemEditor,requestJson,requestId,submitAllFields,versionedRequestItems))})),Promise.all(requestItemPromises).then(items=>resolve(requestJson))}))}))},requestItemPromiseHelper=function(requestItemEditor,requestJson,requestId,submitAllFields,versionedRequestItems){return new Promise((function(resolve,reject){if($(requestItemEditor).find("table.requestItemEditorTable:not(.DTFC_Cloned) > tbody > tr").length>0){var requestItemId=$(requestItemEditor).attr("requestitemid"),requestItemTypeId=$(requestItemEditor).attr("requestitemtypeid"),theTable=$(requestItemEditor).find("table.requestItemEditorTable:not(.DTFC_Cloned)"),thisRequestTypeColumns=[...window.requestItemTypesColumns[requestItemTypeId]],thisRequestItemType=versionedRequestItems.find(x=>x.id==requestItemTypeId);theTable.DataTable().draw(!1);var requestItemRowPromises=[];$.each(theTable.DataTable().rows().data(),(function(rowIndex,rowData){requestItemRowPromises.push(requestItemRowPromiseHelper(requestItemId,rowData,requestJson,thisRequestItemType,thisRequestTypeColumns,rowIndex,requestId,submitAllFields))})),Promise.all(requestItemRowPromises).then((function(itemRows){itemRows&&(requestJson.requestItems=requestJson.requestItems.concat(itemRows));var deletedRows=$(theTable[1]).attr("deletedrows");if(deletedRows){var deletedIds=deletedRows.split(",");$.each(deletedIds,(function(idIndex,id){var deletedRequestItem={requestTypeRequestItemTypeId:requestItemId,companyId:globalUserInfo.companyId,id:id,isDeleted:1};requestJson.requestItems.push(deletedRequestItem)}))}resolve()}))}else resolve()}))},requestItemRowPromiseHelper=function(requestItemId,rowData,requestJson,thisRequestItemType,thisRequestTypeColumns,rowIndex,requestId,submitAllFields){return new Promise((function(resolve,reject){var thisRequestItem={requestTypeRequestItemTypeId:requestItemId,companyId:globalUserInfo.companyId,sortOrder:rowData.sortOrder};requestJson.id&&(thisRequestItem.requestId=requestJson.id),"undefined"!=typeof duplicatingRequest&&duplicatingRequest||void 0!==rowData.requestItemId&&(thisRequestItem.id=rowData.requestItemId),requestItemDataPromises=thisRequestTypeColumns.map(requestTypeColumn=>requestItemRowMapper(requestTypeColumn,thisRequestTypeColumns,thisRequestItem,rowIndex,rowData,requestId,thisRequestItemType,submitAllFields)),Promise.all(requestItemDataPromises).then((function(requestItemDataRows){var itemsWithData;requestItemDataRows=requestItemDataRows.filter(x=>x),thisRequestItem.requestItemFields=requestItemDataRows,requestItemDataRows.filter(x=>x.requestItemFieldValues.length>0).length>0?resolve(thisRequestItem):resolve(null)}))}))},clickRequestSubmitButton=async function(requestId,thisRequestType,versionedRequestItems,versionedFields){var prioritizeRequest=utilities().canPrioritizeRequest(thisRequestType),submitMessage=prioritizeRequest?"Gathering prioritized request list...":"Adding your request, please wait...";if(void 0!==window.upsertRequestNotification?window.upsertRequestNotification.update({title:submitMessage,message:""}):window.upsertRequestNotification=$.notify({title:submitMessage,message:""},{delay:0,type:"success",template:utilities().notifyJSTemplates.default,onClose:function(){window.upsertRequestNotification=void 0}}),prioritizeRequest&&$("[reprioritizingRequest=true]").length>0){var requestsArray=[],orderType="requestedOrder";requestId&&isWorkflowManager?(requestsArray=await ajaxModule().getQueueableRequests(thisRequestType.id,window.top.currApp),orderType="assignedOrder"):requestsArray=await ajaxModule().getQueueableRequests(thisRequestType.id,window.top.currApp,globalUserInfo.userId),changeRowsInMyRequestsTable(requestsArray,orderType),window.upsertRequestNotification&&window.upsertRequestNotification.close(),$("#prioritizeThisRequestTableModal").modal("show"),setTimeout((function(){$(".prioritizeThisRequestContainer").animate({scrollTop:$(".prioritizeThisRequestContainer").prop("scrollHeight")},400)}),500),$("body").off("click","button.requestEditorSubmitNewRequest"),$("body").on("click","button.requestEditorSubmitNewRequest",(function(){getStructuresAndSubmit(requestId,!0,!1,()=>{},thisRequestType=thisRequestType,versionedRequestItems=versionedRequestItems,versionedFields=versionedFields)}))}else getStructuresAndSubmit(requestId,!0,!1,(function(){}),thisRequestType=thisRequestType,versionedRequestItems=versionedRequestItems,versionedFields=versionedFields)},submitRequestEditor=async function(requestId,checkRequiredFields=!0,submitAllFields=!1,unnamedProjectList=[],saveCallbackFn=function(saveRequestId,saveRevisionId){},thisRequestType,versionedRequestItems){var maximized_id;$(".cke_maximized").length>0&&$.each($(".cke_maximized"),(function(i,editor){maximized_id=$(editor).parent().attr("id").substring(4),CKEDITOR.instances[maximized_id].execCommand("maximize")}));var inputData={checkRequiredFields:checkRequiredFields,recreateRequestName:!1,appName:window.top.currApp};if(window.parent!=window.self&&null===requestId&&"1"!=window.parent.latestStatus)return window.parent.swal("There was an error trying to save this experiment. Please contact support."),!1;window.top!=window.self&&window.parent.showPopup("savingDiv");var requestIdSelectorString="";if(requestId)requestIdSelectorString=`[requestid=${requestId}]`;else if(""==$('[fieldid="requestType"] select#requestTypeDropdown').val())return $.notify({title:"You must choose a request type.",message:""},{delay:5e3,type:"danger"}),!1;var editor=$(`.dropdownEditorContainer${requestIdSelectorString}`);if(!checkIfAllTablesMeetMinRowCount(thisRequestType,editor))return $(".prioritizeNewRequestButton").attr("disabled",!1),!1;var requestJson=await packageRequest(requestId,thisRequestType,editor,submitAllFields,versionedRequestItems),orderType=$("#prioritizeThisRequestTable").attr("orderType");orderType||(orderType="requestedOrder");var otherRequestedOrders={};requestJson[orderType]=null,utilities().canPrioritizeRequest(thisRequestType)&&$("[reprioritizingRequest=true]").length>0&&$.each($("#prioritizeThisRequestTable tr"),(function(requestIndex,request){var requestId=$(request).attr("requestid"),requestedOrderVal=requestIndex+1;requestId?otherRequestedOrders[requestId]=requestedOrderVal:requestJson[orderType]=requestedOrderVal})),inputData.request=requestJson,inputData.otherOrders=otherRequestedOrders,inputData.orderType=orderType,requestId&&(inputData.preSaveEndpointUrl=workflowServiceEndpointUrl+workflowServiceEndpoints.PRESAVE),inputData.postSaveEndpointUrl=workflowServiceEndpointUrl+workflowServiceEndpoints.POSTSAVE,self==top&&(upsertRequestNotificationTitle=requestId?"Updating request, please wait...":"Adding your request, please wait...",void 0!==window.upsertRequestNotification?window.upsertRequestNotification.update({title:upsertRequestNotificationTitle,message:"",type:"yellowNotification"}):window.upsertRequestNotification=$.notify({title:upsertRequestNotificationTitle,message:""},{delay:0,type:"yellowNotification",template:utilities().notifyJSTemplates.default,onClose:function(){window.upsertRequestNotification=void 0}})),console.log(JSON.stringify(inputData)),$("#prioritizeThisRequestTableModal").modal("hide"),utilities().submitRequest(inputData).then((function(response){requestResponseHandler(response,requestId,unnamedProjectList,saveCallbackFn)})).catch((function(error){error.length>255&&(error=`${error.slice(0,255)}...`),"ELN"!=window.top.currApp?window.upsertRequestNotification.update({title:"Error submitting request! Please contact support.",message:error,type:"danger"}):window.parent.swal("Error submitting request! Please contact support.",error,"error"),$(".submitButton").attr("disabled",!1)}))},requestResponseHandler=async function(response,requestId,unnamedProjectList,saveCallbackFn){console.log("upsertRequest response: ",response);var requestEditor=$(".requestEditorContainer");if(requestEditor.find(".editorFieldValidationErrorLabel, .editorItemFieldValidationErrorLabel").empty(),window.top==window.self||!response.error&&"failed"!=response.result||window.parent.hidePopup("savingDiv"),response.error){var notificationTitle=response.error;return window.top==window.self?window.upsertRequestNotification.update({title:notificationTitle,type:"danger"}):window.parent.swal("",notificationTitle,"error"),$(".prioritizeNewRequestButton").attr("disabled",!1),!1}if("success"!=response.result)return $(".prioritizeNewRequestButton").attr("disabled",!1),errorResponseHandler(requestEditor,response),saveCallbackFn(!1,!1),!1;var submittedLinks=null;if("undefined"!=typeof InterCom&&response.requestId&&(submittedLinks=window.InterCom.props.submitLinks(response.requestId)),unnamedProjectList.length>0){const requestNameResp=await ajaxModule().getRequestName(response.requestId),requestNameJson=utilities().decodeServiceResponce(requestNameResp),requestName=requestNameJson.requestName;await ajaxModule().updateProjectsWithName(unnamedProjectList,requestName)}if(window.top!=window.self&&window.top.experimentJSON&&"experimentId"in window.top.experimentJSON&&"thisRevisionNumber"in window.top.experimentJSON&&"bioEditorIds"in window.top.experimentJSON&&($.each(window.top.experimentJSON.bioEditorIds,(function(index,id){ajaxModule().addEditorToProcQueue(window.top.experimentJSON.experimentId,window.top.experimentJSON.thisRevisionNumber,id)})),window.top.experimentJSON.bioEditorIds=[]),$(".prioritizeNewRequestButton").attr("disabled",!1),void 0!==window.duplicatingRequest&&window.duplicatingRequest&&(window.duplicatingRequest=!1,window.top!=window.self&&(window.requestId=response.requestId,window.parent.$("#requestId").val(response.requestId),$(".dropdownEditorContainer").attr("requestid",response.requestId),window.location.href.includes("repeatRequest.asp"))))var indivReqSrc="/arxlab/workflow/viewIndividualRequest.asp?base=false&inFrame=true&requestid="+response.requestId+"&currentPageMode=custExp",iframe=window.parent.$("#tocIframe").attr("src",indivReqSrc);if(requestId){if(console.log("Successfully updated request."),window.self!=window.top){try{viewIndividualRequest(response.requestId,response.revisionId)}catch{window.parent.$("#tocIframe").attr("src",window.parent.$("#tocIframe").attr("src"))}saveCallbackFn(response.requestId,response.revisionId)}else if(window.upsertRequestNotification.update({title:"Successfully updated your request.",message:"",type:"success"}),setTimeout((function(){window.upsertRequestNotification.close()}),5e3),"/arxlab/workflow/viewIndividualRequest.asp"==window.location.pathname)try{viewIndividualRequest(response.requestId,response.revisionId)}catch{window.location.href=window.location.href}else requestEditor.find(".bottomButtons .requestEditorCancel").click();$("#manageRequestsTable").length>0&&$("#manageRequestsTable").DataTable().draw(),fetchUnreadNotifications()}else{if(console.log("Successfully added request."),window.self!=window.top){window.parent.$("#requestId").val(response.requestId),window.parent.$("#requestRevisionId").val(response.revisionId),saveCallbackFn(response.requestId,response.revisionId);var indivReqSrc="/arxlab/workflow/viewIndividualRequest.asp?base=false&inFrame=true&requestid="+response.requestId+"&currentPageMode=custExp",iframe=window.parent.$("#tocIframe").attr("src",indivReqSrc)}else window.upsertRequestNotification.update({title:"Successfully Submitted your Request.",message:"",type:"success"}),setTimeout((function(){window.upsertRequestNotification.close()}),5e3);if(window.self!=window.top||"makeNewRequest"!=window.CurrentPageMode&&"repeatRequest"!=window.CurrentPageMode)$("#requestEditorModal").modal("hide");else{let url=`${window.location.origin}/arxlab/workflow/viewIndividualRequest.asp?requestid=${response.requestId}`;window.location.href=url}}utilities().fetchNotificationCount(),void 0!==window.unsavedChangesNotification&&window.unsavedChangesNotification.close(),window.unsavedChangesNotificationOpen=!1},errorResponseHandler=function(requestEditor,response){var notificationTitle="Unable to submit your request.",notificationMessage="Please correct any errors and try again.",validationErrors=JSON.parse(response.validationErrors),requestValidationError=validationErrors.requestValidationError;if(requestValidationError)notificationMessage=requestValidationError;else{$.each(validationErrors.requestFieldValidationList,(function(requestFieldIndex,requestFieldError){var errorRequestTypeFieldId=requestFieldError.requestTypeFieldId,editorFieldInputContainers;requestEditor.find(`.editorField[requesttypefieldid=${errorRequestTypeFieldId}] .editorFieldInputContainer`).each((function(inputContainerIndex,inputContainer){requestFieldError.errorList[inputContainerIndex]&&$(inputContainer).find(".editorFieldValidationErrorLabel").text(requestFieldError.errorList[inputContainerIndex])}))}));var requestItemFieldValidationList=validationErrors.requestItemFieldValidationList;$.each(requestEditor.find(".requestItemsEditor"),(function(){var requestItemId=$(this).attr("requestitemid"),table=$(`#requestItemTable${requestItemId}`),requestItemTypeId=table.attr("requestitemtypeid");$.each(table.DataTable().rows().nodes().to$(),(function(rowIndex,rowNode){var dirtyRow=!1,rowData=table.DataTable().row(rowNode).data();if($.each(rowData,(function(key,value){if("object"==typeof value&&"dirty"in value&&value.dirty)return dirtyRow=!0,!1})),!dirtyRow&&table.DataTable().rows().length>1)return!0;var rowErrors=requestItemFieldValidationList.shift();if(null==rowErrors)return console.log("trying to make sure this doesn't execute I guess??"),!1;$.each(rowErrors.requestFieldValidationList,(function(requestItemFieldIndex,requestItemField){var requestItemTypeFieldId=requestItemField.requestTypeFieldId;if(relevantCellDiv=$(rowNode).find('div[requestitemtypefieldid="'+requestItemTypeFieldId+'"]'),console.log(relevantCellDiv),console.log(relevantCellDiv.attr("datatypeid")),relevantCellDiv.length>0){if(thisDataTypeId=parseInt(relevantCellDiv.attr("datatypeid")),isNaN(thisDataTypeId)&&$(relevantCellDiv).hasClass("structureDisplay")&&(thisDataTypeId=8),console.log(thisDataTypeId),thisDataTypeId==dataTypeEnums.TEXT)var inputElement=relevantCellDiv.find('input[type="text"]');else if(thisDataTypeId==dataTypeEnums.LONG_TEXT)var inputElement=relevantCellDiv.find("textarea");else if(thisDataTypeId==dataTypeEnums.INTEGER||thisDataTypeId==dataTypeEnums.REAL_NUMBER)var inputElement=relevantCellDiv.find('input[type="number"]');else if(thisDataTypeId==dataTypeEnums.DROP_DOWN)var inputElement=relevantCellDiv.find("select");else if(thisDataTypeId==dataTypeEnums.FILE_ATTACHMENT)var inputElement=relevantCellDiv.find("form");else if(thisDataTypeId==dataTypeEnums.DATE)var inputElement=relevantCellDiv.find('input[type="text"]');else if(thisDataTypeId==dataTypeEnums.STRUCTURE)var inputElement=relevantCellDiv.find(".structureDisplay");console.log(inputElement),null!=inputElement&&$.each(inputElement,(function(inputElementIndex,thisInputElement){var error=requestItemField.errorList[inputElementIndex];error&&$(thisInputElement).next(".editorItemFieldValidationErrorLabel").text(error)}))}else $.each(versionedRequestItems,(function(index,requestItemType){requestItemType.id==parseInt(requestItemTypeId)&&$.each(requestItemType.fields,(function(fieldIndex,field){field.requestTypeFieldId==requestItemTypeFieldId&&field.required&&alert("Update/Submission Failed: There is a required Item Field which you don't have access to.")}))}))}))})),$(table).DataTable().draw()}))}window.self==window.top?window.upsertRequestNotification.update({title:notificationTitle,message:notificationMessage,type:"danger"}):(window.parent.swal("",notificationMessage,"warning"),window.top.hidePopup("savingDiv"))},findStatusFieldAndQueuedOptionId=function(thisRequestType){return new Promise((function(resolve,reject){var statusFieldSavedFieldId=!1,queuedOptionId=!1,foundStatusField=thisRequestType.fields.find(x=>"1"==x.filterField);if(foundStatusField){statusFieldSavedFieldId=foundStatusField.savedFieldId;var filterVal=foundStatusField.filterValue,statusFieldEditorField;if(foundStatusField.dataTypeId==dataTypeEnums.DROP_DOWN){if((statusFieldEditorField=$(`.editorField[savedfieldid=${statusFieldSavedFieldId}]`)).length>0){var requestFieldRef=$($(statusFieldEditorField).children()[1]).children()[0];"DYNAMIC"!=filterVal?$.each($(requestFieldRef).children(),(function(){this.text==filterVal&&(queuedOptionId=$(this).val())})):queuedOptionId=$(requestFieldRef).val()}}else if(foundStatusField.dataTypeId==dataTypeEnums.TEXT){var statusFieldEditorField;if("DYNAMIC"!=filterVal)queuedOptionId=filterVal;else if((statusFieldEditorField=$(`.editorField[savedfieldid=${statusFieldSavedFieldId}]`)).length>0){var requestFieldRef=$($(statusFieldEditorField).children()[1]).children()[0];queuedOptionId=$(requestFieldRef).val()}}}resolve({statusFieldSavedFieldId:statusFieldSavedFieldId,queuedOptionId:queuedOptionId})}))},filterRequestsToOnlyMine=function(requestsArray){return myRequests=requestsArray.filter(x=>x.requestorId==globalUserInfo.userId),myRequests},orderRequestsByRequestedOrderWithNullsLast=function(requestsArray){return requestsArray.sort((function(a,b){return(null===a.requestedOrder)-(null===b.requestedOrder)||+(a.requestedOrder>b.requestedOrder)||-(a.requestedOrder<b.requestedOrder)})),requestsArray},finalizeRequestEditorInitialization=function(){return new Promise((function(resolve,reject){console.log("complete"),$("#basicLoadingModal").modal("hide"),$(".card-header").on("click",(function(){var reqItemDivs=$(this).parent().children();$.each(reqItemDivs,(function(index,div){$(div).hasClass("card-header")?$.each($(div).children(),(function(divIndex,child){$(child).hasClass("hideFields")&&swapTriangles($(child).children()[0])})):toggleObj(div)}))})),$("#basicLoadingModal").length&&$("#basicLoadingModal").modal("hide"),resolve()}))},genRichText;window.ckEditorInstances={};var initCKEFields=function(obj,index){ClassicEditor.create(obj,{toolbar:{items:["heading","|","fontColor","fontSize","fontFamily","highlight","|","bold","italic","underline","strikethrough","link","|","bulletedList","numberedList","todoList","|","indent","alignment","outdent","|","blockQuote","insertTable","|","code","codeBlock","|","imageInsert","|","MathType","ChemType","specialCharacters","subscript","superscript","|","TimeStamp"]},language:"en",image:{toolbar:["imageTextAlternative","imageStyle:full","imageStyle:side"]},table:{contentToolbar:["tableColumn","tableRow","mergeTableCells","tableCellProperties","tableProperties"]},mention:{feeds:[{marker:"#",feed:getFeedItems,minimumCharacters:0}]}}).then((function(editor){var objVal=$(obj).val();editor.setData(objVal);var objId=$(obj).attr("id");if(window.parent!=window.self&&window.top.experimentJSON){var requestTypeFieldId=$("#"+objId).parent().parent().attr("requesttypefieldid"),draftVal=window.top.experimentJSON[requestTypeFieldId];void 0!==draftVal&&editor.setData(draftVal)}editor.model.document.on("change:data",()=>{window.setTimeout((function(editor){if($(`#${objId}`).parent().parent().addClass("editorField"),utilities().showUnsavedChangesNotification($(`#${objId}`).parent().parent()),window.self!=window.top){var requestTypeFieldId=$("#"+objId).parent().parent().attr("requesttypefieldid"),ckData=editor.getData();window.parent.sendAutoSave(requestTypeFieldId,ckData)}}),0,editor)}),ckEditorInstances[$(obj).attr("id")]=editor,window.top==window.self||window.top.canWrite||(editor.isReadOnly=!0),$(".ck-button").on("click",(function(e){let topVal=$(e.currentTarget).offset().top;document.getElementById(`wrs_modal_dialogContainer[${index}]`).style.top=`${topVal}px`}))}))};function getFeedItems(queryText){return new Promise(resolve=>{var attachmentNames;resolve(window.top.$(".fileName").toArray().map(x=>({id:`#${x.innerHTML}`})).filter(isItemMatching).slice(0,10))});function isItemMatching(item){const searchString=queryText.toLowerCase();return item.id.toLowerCase().includes(searchString)}}var bindRichTextFields,populateDraft=function(versionedRequestItems,versionedFields){return new Promise((function(resolve,reject){var requestFieldIds=[],requestFieldVal=window.parent.$("#requestFieldIds").val(),dropdownPromises=[];requestFieldVal&&void 0!==requestFieldVal&&(requestFieldIds=requestFieldVal.split(","));var requestTypeId=window.parent.$("#requestTypeId").val(),inputIds=[1,2,3,4,7],selectIds=[5,11,12],ckeditorIds=[9];$.each(requestFieldIds,(function(index,requestFieldId){var draftVal=window.parent.$("#"+requestFieldId).val();if(void 0!==draftVal){var draftValArr=draftVal.split("|||"),requestSelectorString,editor=$(".editorField"+`[requesttypefieldid='${requestFieldId}']`);if(editor.length>0){editor.attr("dirty",!0);var editorField=editor[0],dataType=$(editorField).attr("datatypeid");if(inputIds.indexOf(parseInt(dataType))>=0){var inputFieldContainer=$(editorField).children(".editorFieldInputContainer"),inputField=inputFieldContainer.children(".editorFieldInput");if(draftValArr.length>1){if(draftValArr.length>inputFieldContainer.length){var fieldsToAdd=draftValArr.length-inputFieldContainer.length;for(i=0;i<fieldsToAdd;++i)$(inputFieldContainer[inputFieldContainer.length-1]).children(".addEditorFieldInputButton")[0].click(),inputFieldContainer=$(editorField).children(".editorFieldInputContainer")}$.each(inputFieldContainer,(function(childIndex,child){$(child).children(".editorFieldInput").val(draftValArr[childIndex])}))}else inputField.val(draftVal);window.parent.$(`#${requestFieldId}`).remove()}else selectIds.indexOf(parseInt(dataType))>=0?dropdownPromises.push(populateDropdownDraft(editor,editorField,draftVal,draftValArr,requestTypeId)):ckeditorIds.indexOf(parseInt(dataType))}}})),populateRequestItemDrafts(selectIds,versionedRequestItems,versionedFields),Promise.all(dropdownPromises).then((function(){resolve(!0)}))}))},populateRequestItemDrafts=function(selectIds,versionedRequestItems,versionedFields){if(window.top==window.self)return!1;$.each($("table.requestItemEditorTable"),(function(idx,obj){if(void 0===$(obj).attr("id"))return!0;var table;try{table=$(obj).DataTable()}catch(err){return!0}"makeNewRequest"==window.CurrentPageMode&&$.each(table.rows()[0],(function(rowIndex,rowCount){requestItemTableHelpers().setDefaultItemFieldValues($(obj).attr("id"),rowIndex)}));var tableId=$(obj).attr("id"),draftTable=window.top.$(`#${tableId}`).val();if(null!=draftTable){var draftVal=JSON.parse(draftTable),table;(table=$(`#${tableId}`).DataTable()).clear(),$.each(draftVal,(function(i,row){table.row.add(row)})),table.draw()}else{var draftVals=window.parent.$('[id*="'+$(obj).attr("id")+'_"]');$.each(draftVals,(function(i,o){var dataObj={};try{dataObj=JSON.parse($(o).val())}catch(err){return!0}if(!dataObj.hasOwnProperty("row")||!dataObj.hasOwnProperty("column")||!dataObj.hasOwnProperty("valuesArray"))return!0;for(;table.rows().count()<=dataObj.row;)dataTableModule().addRequestItemRow($(obj).attr("id"),versionedRequestItems,versionedFields);var theCell=table.cell({row:dataObj.row,column:dataObj.column});console.error("theCell.node() ",theCell.node()),theCell.data(dataObj.valuesArray),console.error("dataTypeId: ",dataObj.dataTypeId),selectIds.indexOf(parseInt(dataObj.dataTypeId))>=0&&(console.error("found drop down"),valuesArray=dataObj.valuesArray,$.each($(theCell.node()).find("select"),(function(cellNum,cellObj){console.error("found cellObj: ",cellObj),$(cellObj).val(valuesArray.data[cellNum])})))}))}$.each(table.rows()[0],(function(rowIndex,rowCount){requestItemTableHelpers().applyItemDependencies($(obj).attr("id"),rowIndex,versionedRequestItems,versionedFields)}))}))},populateDropdownDraft=function(editor,editorField,draftVal,draftValArr,requestTypeId){return new Promise((function(resolve,reject){var inputFieldContainer=$(editorField).children(".editorFieldInputContainer"),inputField=inputFieldContainer.children(".editorFieldDropdown");if(draftValArr.length>1){if(draftValArr.length>inputFieldContainer.length){var fieldsToAdd=draftValArr.length-inputFieldContainer.length;for(i=0;i<fieldsToAdd;++i)$(inputFieldContainer[inputFieldContainer.length-1]).children(".addEditorFieldInputButton")[0].click(),inputFieldContainer=$(editorField).children(".editorFieldInputContainer")}$.each(inputFieldContainer,(function(childIndex,child){$(child).children(".editorFieldDropdown").val(draftValArr[childIndex])}))}else inputField.val(draftVal),$(inputField).trigger("change");resolve(!0)}))},generateRequestDetailsRow=function(request,parentDiv,thisRequestType=null,versionedRequestItems=null,versionedFields=null){console.log(request),ajaxModule().isThisTheMostRecent(request.requestTypeId,request.dateCreated).then((function(response){var userGroup=window.groupsList.find(x=>x.id==request.assignedGroupId),userGroupName="";null!=userGroup&&(userGroupName=userGroup.name),$(".requestEditorContainer.card").empty(),$("#requestEditorModal > .modal-dialog > .modal-content > .modal-footer").remove(),$("#requestEditorModal > .modal-dialog > .modal-content > .modal-body").remove(),requestEditorContainer=$('<div class="dropdownEditorContainer makeVisible requestEditorContainer card">').attr("requestid",request.id),requestEditorContainer.append($("<div>").addClass("modalTitleFixed").text(request.requestName)),window.self!=window.top&&$(requestEditorContainer).addClass("nopadding");var repeatThisRequestDiv=!1,viewRequestTypeDiffDiv=!1,requestNameElement=!1,requestTypeNameElement=!1,requestIsApprovedElement=!1,requestApprovalInfoElement=!1,requestNotebookLinkElement=!1,requestProjectLinkElement=!1,requestDateCreatedElement=!1,requestAssignedGroupElement=!1;if(null==window.duplicatingRequest&&("repeatRequest"!=window.CurrentPageMode?window.duplicatingRequest=!1:window.duplicatingRequest=!0),window.self==window.top){if(response.value&&("undefined"==typeof duplicatingRequest||!duplicatingRequest)){var repeatThisRequestButton=$("<button></button>").addClass("repeatThisRequestButton basicActionButton").attr("id","repeatRequestBTN").text("Repeat This Request");repeatThisRequestDiv=$("<div></div>").addClass("repeatThisRequestButtonContainer").append(repeatThisRequestButton)}var viewRequestTypeDivButton=$("<a>").addClass("basicActionButton").attr("id","viewRequestTypeDiffBtn").attr("href",`/arxlab/workflow/manageConfiguration/viewRequestTypeDiff.asp?id=${request.requestTypeId}&r=${request.dateCreated}`).attr("target","_blank").text("View Request Type Diff");if(viewRequestTypeDiffDiv=$("<div>").addClass("requestTypeDiffButtonContainer").append(viewRequestTypeDivButton),request.projectCode&&(requestNameElement=$('<div class="editorField">').attr("fieldid","requestName").append($('<label class="editorFieldLabel">Request Name</label>'),$('<div class="textValue"></div>').text(request.requestName))),requestTypeNameElement=$('<div class="editorField">').attr("fieldid","requestTypeName").attr("requesttypeid",thisRequestType.id).append($('<label class="editorFieldLabel">Request Type</label>'),$('<div class="textValue"></div>').text(thisRequestType.displayName)),requestDateCreatedElement=$('<div class="editorField">').attr("fieldid","requestDateCreated").append($('<label class="editorFieldLabel">Date Created</label>'),$('<div class="textValue"></div>').text(moment(request.dateCreated).format("MM/DD/YYYY"))),requestAssignedGroupElement=$('<div class="editorField">').attr("fieldid","assignedUserGroup").append($('<label class="editorFieldLabel">Assigned User Group</label>'),$('<div class="textValue"></div>').text(userGroupName)),1==request.needsApproval&&(requestIsApprovedElement=$('<div class="editorField">').attr("fieldid","requestIsApproved").append($('<label class="editorFieldLabel" for="dropdownEditor_isApproved_cb">Is Approved</label>'),$('<input type="checkbox" class="editorFieldCheckbox" name="dropdownEditor_isApproved_cb">').prop("checked",request.isApproved)),requestIsApproved)){var approvedByUser=request.approvedByUserFullName;request.dateApproved=request.dateCreated,requestApprovalInfoText=`Approved by ${approvedByUser} on ${moment(request.dateApproved).format("MM/DD/YYYY")}`,requestApprovalInfoElement=$('<div class="editorField">').attr("fieldid","requestApprovalInfo").append($('<span class="textValue"></span>').text(requestApprovalInfoText))}!request.notebookId||"undefined"!=typeof inIframe&&inIframe||(requestNotebookLinkElement=$('<div class="editorField">').attr("fieldid","notebookLink").append($('<a class="notebookLink" target="_blank">View Notebook</a>').attr("href",`/arxlab/show-notebook.asp?id=${request.notebookId}`))),!request.projectId||"undefined"!=typeof inIframe&&inIframe||(requestProjectLinkElement=$('<div class="editorField">').attr("fieldid","projectLink").append($('<a class="projectLink" target="_blank">View Project</a>').attr("href",`/arxlab/show-project.asp?id=${request.projectId}`)))}var requestEditorFieldsSectionElement=$('<div class="requestFieldsSection">');window.self==window.top&&requestEditorFieldsSectionElement.append($('<label class="editorSectionLabel">Fields</label>')),requestEditorFieldsSectionElement.append($('<div class="editorSection" sectionid="requestFields">')),requestEditorContainer.append(repeatThisRequestDiv),isSupport&&requestEditorContainer.append(viewRequestTypeDiffDiv),requestEditorContainer.append(requestNameElement),requestEditorContainer.append(requestTypeNameElement),requestEditorContainer.append(requestDateCreatedElement),requestEditorContainer.append(requestAssignedGroupElement),requestEditorContainer.append(requestIsApprovedElement),requestEditorContainer.append(requestApprovalInfoElement),requestEditorContainer.append(requestNotebookLinkElement),requestEditorContainer.append(requestProjectLinkElement),requestEditorContainer.append(requestEditorFieldsSectionElement),parentDiv.prepend(requestEditorContainer.append(requestEditorFieldsSectionElement));var selectorString=".dropdownEditorContainer[requestid='"+request.id+"'] .editorSection[sectionid='requestFields']",isManager,canReprioritize=isWorkflowManager||request.requestorId==globalUserInfo.userId,fieldPromises=[];fieldPromises.push(populateRequestFieldsSection(thisRequestType,selectorString,request,canReprioritize,versionedFields,versionedRequestItems)),fieldPromises.push(populateRequestItemsEditorSectionInRequestEditor(request,thisRequestType,requestEditorContainer,versionedRequestItems,versionedFields)),Promise.all(fieldPromises).then((async function(){await dataTableModule().convertSavedRequestDataForDT(request,thisRequestType,versionedRequestItems,versionedFields),populateDraftVals(thisRequestType,versionedRequestItems,versionedFields),requestEditorBottomButtonsElement=$('<div id="UpdateRequestButtons" class="bottomButtons" style="display: none;">'),window.self==window.top&&requestEditorBottomButtonsElement.append($('<button class="requestEditorSubmit submitButton btn btn-success">Update Request</button>'),$('<button class="requestEditorCancel workflowBtn cancelButton btn btn-danger">Cancel Changes</button>')),requestEditorContainer.append(requestEditorBottomButtonsElement),0==request.canEdit&&(requestEditorContainer.addClass("notEditable"),setTimeout((function(){$('.requestEditorContainer[requestid="'+request.id+'"] .requestItemsEditor .requestItemEditorTable > tbody').find("input, select, button").prop("disabled",!0)}),2e3)),$("body").off("click",".requestEditorContainer .requestEditorSubmit"),$("body").on("click",".requestEditorContainer .requestEditorSubmit",(function(event){if($(".isCheckedOut")[0])void 0!==window.upsertRequestNotification?window.upsertRequestNotification.update({title:"Error",message:"A structure needs to be checked in.",type:"danger"}):window.upsertRequestNotification=$.notify({title:"Error",message:"A structure needs to be checked in."},{delay:0,type:"danger",template:utilities().notifyJSTemplates.default,onClose:function(){window.upsertRequestNotification=void 0}});else{var requestId=$(this).closest(".requestEditorContainer").attr("requestid"),IdHolder=requestId;requestId=isNaN(IdHolder)?null:parseInt(IdHolder),clickRequestSubmitButton(requestId,thisRequestType,versionedRequestItems,versionedFields)}}))}))}))},populateRequestItemsEditorSectionInRequestEditor=function(request,requestType,requestEditorContainer,versionedRequestItems,versionedFields){return new Promise((function(resolve,reject){$(".requestItemsEditorSection").empty(),requestItemTableNames=[];var isOldRevision="undefined"!=typeof requestRevId&&""!=requestRevId,isNewRequest=!request,canWrite=0==requestType.restrictAccess||1==requestType.canEdit;window.self!=window.top&&(canWrite=window.parent.canWrite),allRequestItemTypesEditors=$("<div>"),$.each(requestType.requestItemTypes,(function(requestItemTypeIndex,requestItemType){var requestItemsEditor=$('<div class="requestItemsEditor"></div>').attr("requestitemtypeid",requestItemType.requestItemTypeId).attr("requestitemid",requestItemType.requestItemId),cardHeader=$('<div class="card-header" data-background-color="green"></div>').append($('<h4 class="title"></h4>').text(requestItemType.requestItemName));cardHeader.append($("<div class='hideFields'></div>").append($("<img class='requestItemTriangle'></img>").attr("src","/arxlab/images/nav-down.gif")));var requestItemsFileUploadForm=tableFileUpload.makeRequestItemsFileUploadForm(requestItemTypeIndex,requestItemType,versionedRequestItems);requestItemTableNames.push(`#requestItemTable${requestItemType.requestItemId}`);var requestItemEditorTable=$("<table>").addClass("requestItemEditorTable display").attr("requestitemtypeid",requestItemType.requestItemTypeId).attr("id",`requestItemTable${requestItemType.requestItemId}`).attr("deleteonedit",requestItemType.deleteOnEdit).attr("tablenum",requestItemTypeIndex).attr("cellspacing",0),sdfTableContainer=$('<div class="sdfTableContainer insideSavedRequestEditor"></div>').append(requestItemEditorTable),cardContent=$('<div class="fileUploadSection card-content"></div>').append(requestItemsFileUploadForm).append(sdfTableContainer),cardObj=$('<div class="card"></div>').append(cardHeader,cardContent);if(!isOldRevision&&canWrite){cardObj.append("<button class='addRequestItem btn btn-success' tableid='requestItemTable"+requestItemType.requestItemId+"'>Add New Row</button>");var resumableOptions={target:"/excel2CSV/Upload",query:{connectionId:connectionId,companyId:companyId,userId:globalUserInfo.userId,appName:"Workflow"},headers:{Authorization:jwt},generateUniqueIdentifier:resumableGenerateUniqueIdentifier,fileType:tableFileUpload.getAcceptedFileTypes(requestItemType.requestItemTypeId,versionedRequestItems).map(x=>x.substring(1,x.length))},fileAddedCallbackFn=async function(file,rObj){requestItemsFileUploadForm.find(".sdfUploadStatusHolder").text(file.fileName);var originalFileName,splitFile=file.fileName.split("."),fileExtension=splitFile[splitFile.length-1].toLowerCase();"sdf"==fileExtension?tableFileUpload.displayFileImportOptions(`requestItemTable${requestItemType.requestItemId}`,"new",null,requestItemTypeIndex,`.${fileExtension}`,"",requestItemType.requestItemTypeId,isNewRequest,file.file,versionedRequestItems,versionedFields):($("#basicLoadingModal").show(),rObj.upload())},fileSuccessCallbackFn=function(file,response,rObj){$("#basicLoadingModal").hide();var responseData=JSON.parse(response),originalFileName=file.fileName,newFileName=responseData.newFileName,fileExtension=responseData.fileExt.toLowerCase(),requestObj={connectionId:connectionId,requestItemTypeId:requestItemType.requestItemTypeId,jwt:jwt,originalFileName:originalFileName,newFileName:newFileName,fileExtension:fileExtension,appName:window.top.currApp},tableId="requestItemTable"+requestItemType.requestItemId;tableFileUpload.displayFileImportOptions(tableId,"new",requestObj,requestItemTypeIndex,fileExtension,newFileName,requestItemType.requestItemTypeId,isNewRequest,null,versionedRequestItems,versionedFields),rObj.removeFile(file),utilities().showUnsavedChangesNotification()},resumableObject=resumableModule(resumableOptions,cardContent,requestItemsFileUploadForm.find(".resumable-browse"));resumableObject.addFileCallback(fileAddedCallbackFn),resumableObject.addFileSuccessCallback(fileSuccessCallbackFn)}cardObj.append("<button class='generateCSV btn btn-success' tableid='requestItemTable"+requestItemType.requestItemId+"'>Download CSV</button>"),null!=versionedRequestItems.find(x=>x.id==requestItemType.requestItemTypeId).fields.find(x=>8==x.dataTypeId)&&cardObj.append("<button class='generateSDF btn btn-success' tableid='requestItemTable"+requestItemType.requestItemId+"'>Download SDF</button>"),Object.keys(requestItemType).indexOf("requestItemHoverText")>=0&&requestItemType.requestItemHoverText&&cardObj.attr("title",requestItemType.requestItemHoverText),requestItemsEditor.append(cardObj),allRequestItemTypesEditors.append(requestItemsEditor)})),requestEditorContainer.append(allRequestItemTypesEditors.children()),resolve(requestEditorContainer)}))},insertRequestFieldsToggle=function(){$("<div id='hideFields' class='hideFields'><img id='triDown' class='requestFieldTriangle' src='/arxlab/images/nav-down.gif'></div>").on("click",(function(){var fieldObjs=$(".requestFieldsSection").children();$.each(fieldObjs,(function(index,fieldObj){$(fieldObj).hasClass("editorSection")&&toggleObj(fieldObj)})),swapTriangles("#triDown")})).insertBefore(".editorSection")},toggleObj=function(obj){var divObj=$(obj);$(divObj).is(":visible")?$(divObj).hide():$(divObj).show(),utilities().resizeCustExpIframe()},swapTriangles=function(div){var src,down="/arxlab/images/nav-down.gif",right="/arxlab/images/nav-right.gif";$(div).attr("src")==down?$(div).attr("src",right):$(div).attr("src",down)},populateUserGroupsList=function(){return new Promise((function(resolve,reject){if($("select#assignedUserGroupDropdown").children().length>0)resolve(!0);else{var dropdown=$("<select></select>");$.each(window.groupsList,(function(){groupId=this.id,groupName=this.name;var groupOption=$("<option></option>").attr("value",groupId).attr("groupid",groupId).text(groupName);dropdown.append(groupOption)})),$("select#assignedUserGroupDropdown").html(dropdown.html()),resolve(!0)}}))},getStructuresAndSubmit=async function(requestId,checkRequiredFields=!0,submitAllFields=!1,saveCallbackFn=function(saveRequestId,saveRevisionId){},thisRequestType=null,versionedRequestItems=window.requestItemTypesArray,versionedFields=window.savedFieldsArray){var structureHolders=$(".structureImageContainer"),promisArray=[],promisKeys=[];$.each(structureHolders,(function(){var thisId=$(this).find(".editStructureLink").attr("liveeditid");null==thisId&&(thisId=$(this).find(".isReadOnly").attr("liveeditid")),promisArray.push(getChemistryEditorChemicalStructure(thisId,!1)),promisKeys.push(thisId)}));const VALUES=await Promise.all(promisArray);var compoundRegPromiseArray=[];$.each(VALUES,(function(index,item){var liveEditId=promisKeys[index];allStructures[liveEditId]=null==item?getEmptyMolFile():item;var registerCompound=!1,isRequestEditorLink,regVal;if(liveEditId.includes("itemType")){var requestItemTypeId=$("[liveeditid="+liveEditId+"]").parents(".requestItemsEditor").attr("requestItemTypeId"),thisRequestItemType;registerCompound=versionedRequestItems.find(x=>x.id==requestItemTypeId).registerNewCompounds}else registerCompound=thisRequestType.registerNewCompounds;regVal=$("[liveeditid="+liveEditId+"]").parents(".editorFieldInputContainer").length>0?$("[liveeditid="+liveEditId+"]").parents(".editorSection.card").find("[datatypeid="+dataTypeEnums.REGISTRATION+"] > div.editorFieldInputContainer > a").val():$("[liveeditid="+liveEditId+"]").closest("tr").find("[datatypeid="+dataTypeEnums.REGISTRATION+"] > a").val(),registerCompound&&!regVal&&compoundRegPromiseArray.push(promisKeys[index])})),await registerOneStrucAtATime(compoundRegPromiseArray,versionedRequestItems,versionedFields);const UNNAMED_PROJECT_LIST=await autoGenerateElnObjects(versionedRequestItems,versionedFields);submitRequestEditor(requestId,checkRequiredFields,submitAllFields,UNNAMED_PROJECT_LIST,saveCallbackFn,thisRequestType,versionedRequestItems)},autoGenerateElnObjects=function(versionedRequestItems,versionedFields){return new Promise((function(resolve,reject){var autoGenPromises=[];$.each($("input[autogen=1]"),(function(inputIndex,editor){var select2Data=$(editor).select2("data");select2Data&&-1!=select2Data.id||("searchForNotebook"==$(editor).attr("id")&&autoGenPromises.push(elnAutomation().genNotebook("",editor)),"searchForProject"==$(editor).attr("id")&&autoGenPromises.push(elnAutomation().genProject("",editor)))})),Promise.all(autoGenPromises).then((function(autoGenResponses){let unnamedProjectList=[];$.each(autoGenResponses,(function(i,autoGenResponse){autoGenResponse.inTable&&dataTableModule().updateRequestItemsTableDataAndRedraw(autoGenResponse.editor,versionedRequestItems,versionedFields),autoGenResponse.isProject&&unnamedProjectList.push(autoGenResponse.id)})),resolve(unnamedProjectList)}))}))},unsortedTablesCheck,registerOneStrucAtATime=function(keysArr,versionedRequestItems,versionedFields){return new Promise((function(resolve,reject){0==keysArr.length?resolve(!0):utilities().addStructureToReg(keysArr[0],versionedRequestItems,versionedFields).then((function(resp){console.log(`Registered ${keysArr[0]}`),keysArr.shift(),resolve(registerOneStrucAtATime(keysArr,versionedRequestItems,versionedFields))}))}))},changeRowsInMyRequestsTable=function(requestsArray,orderType){var myRequestsTableRows=generateMyRequestsTableRows(requestsArray);$("table#prioritizeThisRequestTable tbody tr:not(.thisNewRequestRow)").remove(),$("table#prioritizeThisRequestTable tbody").prepend(myRequestsTableRows),$("table#prioritizeThisRequestTable").attr("orderType",orderType)},generateMyRequestsTableRows=function(requestsArray){myRequestsTableRowsArray=[];var parsedRequestsArray=JSON.parse(requestsArray.data);return $.each(parsedRequestsArray,(function(requestIndex,request){var tableRow=$("<tr></tr>").attr("requestid",request.id),reorderRowTd=$("<td>").append($("<div>").text(request.requestTypeName).addClass("requestTypeName"));if(void 0!==request.requestName)var requestedOrderHolder=$("<div>").text(requestIndex+1).addClass("requestedOrder"),requestNameHolder=$("<div>").text(request.requestName).addClass("requestName"),dateCreatedHolder=$("<div>").text(moment(request.dateCreated).format("MM/DD/YY")).addClass("requestDate"),numItemsHolder=$("<div>").text(request.requestItemCount).addClass("numberOfItems"),previewStructuresHolder=$("<div>").html('<i class="material-icons previewStructuresButton">chevron_right</i>').addClass("previewStructuresButtonHolder"),reorderRowTd=$("<td>").append(requestedOrderHolder,requestNameHolder,dateCreatedHolder,numItemsHolder,previewStructuresHolder);tableRow.append(reorderRowTd),myRequestsTableRowsArray.push(tableRow)})),myRequestsTableRowsArray};return{populateRequestFieldsSection:populateRequestFieldsSection,populateDraftVals:populateDraftVals,findStatusFieldAndQueuedOptionId:findStatusFieldAndQueuedOptionId,filterRequestsToOnlyMine:filterRequestsToOnlyMine,orderRequestsByRequestedOrderWithNullsLast:orderRequestsByRequestedOrderWithNullsLast,finalizeRequestEditorInitialization:finalizeRequestEditorInitialization,bindRichTextFields:function(versionedRequestItems,versionedFields){return new Promise((function(resolve,reject){clearTimeout(genRichText),window.preventNotification=0,genRichText=setTimeout((function(){var ckPromises=[];requestFieldHelper().initAllSealectFields(versionedRequestItems,versionedFields),$.each($(".ckEditorField"),(function(i,obj){ckPromises.push(initCKEFields(obj,i))})),Promise.all(ckPromises).then((function(editors){resolve(!0)}))}),1e3)}))},generateRequestDetailsRow:generateRequestDetailsRow,populateRequestItemsEditorSectionInRequestEditor:populateRequestItemsEditorSectionInRequestEditor,insertRequestFieldsToggle:insertRequestFieldsToggle,populateUserGroupsList:populateUserGroupsList,unsortedTablesCheck:function(callbackFn){dataTableModule().allTablesSorted()?callbackFn():window.top.swal({title:"Request item table(s) are unsorted!",type:"warning",text:"You have at least one request item table that is not sorted in Priority order. This will irreversibly alter the Priority of your tables if submitted like this.",showCancelButton:!0,confirmButtonText:"Submit"},(function(){callbackFn()}))},getStructuresAndSubmit:getStructuresAndSubmit,clickRequestSubmitButton:clickRequestSubmitButton,packageRequest:packageRequest,errorResponseHandler:errorResponseHandler,initCKEFields:initCKEFields}},requestEditorHelper=requestEditorModule();
//# sourceMappingURL=requestEditorModule.min.js.map