var manageRequestsModule=function(){var TF=!1,initManageRequestsTable=function(visibleRequestTypeId){$.fn.DataTable.isDataTable("table#manageRequestsTable")&&($("table#manageRequestsTable").DataTable().destroy(),$("table#manageRequestsTable tbody, table#manageRequestsTable thead").empty()),priorityColumnTitle="Start order";var priorityName="assignedOrder";window.manageMyRequests&&(priorityColumnTitle="Priority",priorityName="requestedOrder");var tableColumns=[{data:priorityName,name:priorityName,orderable:!0,title:priorityColumnTitle,width:"0px",visible:!0,searchable:!0},{className:"dragHandle",name:"",orderable:!1,data:null,defaultContent:"",title:"",render:function(data,type,row){var requestItemDragHandle=$('<div title="Drag Handle" class="manageRequestDragHandle iconHelpr">').append($('<i class="material-icons">').text("reorder")),requestItemDragToReorder=$('<button title="Drag Handle" class="manageRequestDragHandle btn">');if(requestItemDragToReorder.append(requestItemDragHandle),!window.top.rowReorderLocked&&!window.top.rowReorderLockedByReorder&&row.isQueueable)return requestItemDragToReorder.prop("outerHTML")}},{className:"details-control",name:"",orderable:!1,data:null,defaultContent:"",title:""},{data:"requestName",title:"Name",name:"requestName",visible:!0,searchable:!1,className:"requestName"}];window.manageMyRequests||tableColumns.push({data:"requestorName",name:"requestor",title:"Requestor"},{data:"requestedOrder",name:"requestedOrder",title:"Requestor Priority"}),tableColumns.push({data:"numberOfItems",name:"numItems",title:"# of Items"}),tableColumns.push({data:"dateCreated",name:"dateCreated",title:"Date Created",render:function(data,type,row){return`<div class="dateCellHiddenEpoch"></div><div class='dateCreatedCell'>${moment.utc(data).local().format("MM/DD/YY LT")}</div>`}});var activeRequestType=window.requestTypesArray.find(x=>x.id==visibleRequestTypeId);if(activeRequestType&&activeRequestType.fields.length>0){activeRequestType.fields=utilities().removeDuplicatedFields(activeRequestType.fields);var fieldsICanSee=utilities().checkPerm(activeRequestType.fields);fieldsICanSee.length>0&&fieldsICanSee.map((function(field){1==field.inRequestsTable&&(console.log(field),13==field.dataTypeId||14==field.dataTypeId||15==field.dataTypeId?tableColumns.push({data:field.requestTypeFieldId,title:field.displayName,name:String(field.requestTypeFieldId),dataTypeId:field.dataTypeId,searchable:!0,orderable:!1,render:function(data,type,row){if(null!=data){var display="";return $.each(data,(function(i,item){var buildJson={id:-1};try{if(item&&0!=parseInt(item)&&window.top.linkData&&Array.isArray(window.top.linkData)&&window.top.linkData.length>0){var link=window.top.linkData.find(x=>x.linkSvcId==item);link&&(buildJson={id:link.linkId,text:link.linkName},"abr"in link&&(buildJson.index=link.abr))}}catch(error){}if(buildJson.id<=0||null==buildJson.id||null==buildJson.id)return"";var onClickFnc="";field.dataTypeId==dataTypeEnums.NOTEBOOK?onClickFnc=`requestFieldHelper().NavToNotebook(${String(buildJson.id)});`:field.dataTypeId==dataTypeEnums.PROJECT?onClickFnc=`requestFieldHelper().NavToProject(${String(buildJson.id)});`:field.dataTypeId==dataTypeEnums.EXPERIMENT&&(onClickFnc=`requestFieldHelper().NavToExperement(${String(buildJson.id)}, '${String(buildJson.index)}');`),display+=`<a href="JavaScript:void(0);" class="navigateLink btn btn-info btn-sm" onClick="${onClickFnc}">${buildJson.text}</a>`})),display}return""}}):tableColumns.push({data:field.requestTypeFieldId,title:field.displayName,name:String(field.requestTypeFieldId),dataTypeId:field.dataTypeId,searchable:7!=field.dataTypeId,render:function(data,type,row){return field.dataTypeId==dataTypeEnums.DATE&&data&&"null"!=data&&(data=moment(data).format("MM/DD/YY")),data}}))}))}var ViewOption=25;""!=utilities().getCookie("displayOptions")&&(ViewOption=parseInt(utilities().getCookie("displayOptions"))),isNaN(ViewOption)&&(ViewOption=25);var rowReorderSetting=!1,sourceData=window.manageMyRequests?"requestedOrder":"assignedOrder",isMember;(isWorkflowManager||window.manageMyRequests)&&(rowReorderSetting={dataSrc:sourceData,selector:"td:nth-of-type(2) .manageRequestDragHandle",snapX:!0},$("body").addClass("showUpdateRequestsAssignedOrderButton"));var linkFields=[],leftCols=1,selRequestTypeIds=[];activeRequestType&&(leftCols=activeRequestType.frozenColumnsLeft,selRequestTypeIds.push(activeRequestType.id),linkFields=activeRequestType.fields.filter(x=>(x.dataTypeId==dataTypeEnums.PROJECT||x.dataTypeId==dataTypeEnums.NOTEBOOK||x.dataTypeId==dataTypeEnums.EXPERIMENT)&&x.inRequestsTable));var fixedColumnsSetting=!1;fixedColumnsSetting={leftColumns:parseInt(leftCols)};var manageRequestsTable=$("table#manageRequestsTable").DataTable({serverSide:!0,ajax:function(data,callback,settings){var sendObj={requestTypeId:selRequestTypeIds,appName:window.currApp,getRequestCounts:!0,searchString:data.search.value,recordsPerPage:data.length,pageNumber:Math.floor((data.start+1)/data.length),getFieldData:!0,fetchColumnFilterOptions:!0,orderBy:""},columnFilters={},filterOptions=data.columns.map((function(x){if(""!=x.search.value){var retObj={};if(retObj[x.name]=x.search.value.split("|"),"requestor"==x.name){var searchArray=JSON.stringify(x.search.value.split("|"));sendObj.requestorNames=searchArray}else columnFilters[x.name]=x.search.value.split("|");return retObj}return{}}));$.each(data.order,(function(index,item){var name=data.columns[[item.column]].name;""!=sendObj.orderBy&&(sendObj.orderBy+=", "),sendObj.orderBy+=`${name}:${item.dir}`})),data.order.length>0?0==data.order[0].column&&utilities().isEmpty(columnFilters)&&null==sendObj.requestorNames?window.top.rowReorderLockedByReorder=!1:window.top.rowReorderLockedByReorder=!0:window.top.rowReorderLockedByReorder=!1,Object.keys(columnFilters).length>0?sendObj.requestFieldFilters=JSON.stringify(columnFilters):sendObj.requestFieldFilters=null,sendObj.defaultOrder="assignedOrder:asc",window.manageMyRequests&&(sendObj.requestorIds=[globalUserInfo.userId],sendObj.defaultOrder="requestedOrder:asc"),sendObj.defaultOrder==sendObj.orderBy&&(sendObj.orderBy=""),ajaxModule().getFromAppService(appServiceEndpoints.SEARCH,sendObj).then((function(r){if("object"==typeof r)if("success"==r.result){console.log(settings);let resData=JSON.parse(r.data);if(linkFields.length>0){var linksToFetch=[];resData.forEach(x=>{linkFields.forEach(field=>{linksToFetch=linksToFetch.concat(x[field.requestTypeFieldId])})}),linksToFetch=[...new Set(linksToFetch.filter(x=>x))],window.top.linkData&&Array.isArray(window.top.linkData)&&(linksToFetch=linksToFetch.filter(x=>!window.top.linkData.includes(parseInt(x)))),(linksToFetch=linksToFetch.filter(x=>0!=parseInt(x)&&null!=x)).length>0?ajaxModule().getLinksByIds(linksToFetch).then((function(response){ajaxModule().decodeLinks(response).then((function(){applySearchData(resData,data,r,callback)})).catch(reason=>{console.warn(`Decode links faild with: ${reason}`)})})).catch(reason=>{console.warn(`Get links faild with: ${reason}`)}):applySearchData(resData,data,r,callback)}else applySearchData(resData,data,r,callback)}else swal("Error In Service",r.error,"error");else swal("Error In Service","Request Timed Out","error")}))},processing:!0,language:{loadingRecords:"<div class='blueLoadingSpinner'></div><br>Loading...",processing:"<div class='blueLoadingSpinner'></div><br>Loading..."},columns:tableColumns,order:[],paging:!0,autoWidth:!1,columnDefs:[{searchable:!1,targets:[0,7]}],drawCallback:function(settings){requestDrawCallBack.call(this,settings)},headerCallback:function(thead,data,start,end,display){$(thead).find("th").each((function(tableHeaderIndex,tableHeader){var colHeaderText=$(tableHeader).clone().children().remove().end().text();if(void 0!==tableColumns[tableHeaderIndex]&&(5==tableColumns[tableHeaderIndex].dataTypeId||"requestorName"==tableColumns[tableHeaderIndex].data)){var filterButton=$('<div class="columnFilterButton"></div>');$(tableHeader).html(colHeaderText+$("<div>").append($(filterButton)).html())}}))},pageLength:ViewOption,scrollX:!0,scrollY:700,rowReorder:rowReorderSetting,fixedColumns:fixedColumnsSetting});return manageRequestsTable.on("row-reordered",(function(event,diff,edit){rowReorderHandler(event,diff,edit)})),$(".form-control.input-sm").bind("change",(function(e){document.cookie="displayOptions = "+$(e.target).val()})),tableColumnsForYadcf=[],$.each(tableColumns,(function(tableColumnIndex,tableColumn){if("requestorName"==tableColumn.data||5==tableColumn.dataTypeId){var tableColumnConfig={column_number:tableColumnIndex,filter_default_label:"-- Filter --",column_data_type:"text",filter_type:"multi_select",select_type:"select2",filter_match_mode:"contains",select_type_options:{width:"150px",placeholder:"Select tag",allowClear:!0,sortResults:function(data){return data.sort((function(a,b){return(a=a.text.toLowerCase())>(b=b.text.toLowerCase())?1:a<b?-1:0}))}},html_data_type:"text",filter_reset_button_text:!1};tableColumnsForYadcf.push(tableColumnConfig)}})),yadcfTableConfigOptions={},tableColumnsForYadcf.length>0&&yadcf.init(manageRequestsTable,tableColumnsForYadcf),$("#basicLoadingModal").modal("hide"),$(window).resize(),!1},applySearchData=function(resData,data,response,callback){var retOBJ={data:resData,draw:data.draw,recordsTotal:response.recordsTotal,recordsFiltered:response.recordsPassingFilter};retOBJ.yadcf_data_4=response.columnFilterData.requestors,$.each(response.columnFilterData,(function(key,val){var fieldId=key;if(""!=fieldId){var col=data.columns.findIndex(x=>parseInt(x.name)==fieldId);-1!=col&&(retOBJ[`yadcf_data_${col}`]=val)}})),callback(retOBJ)},requestDrawCallBack=function(settings){$(".columnFilterButton").on("click",(function(event){console.log("CLICKED COLUMN FILTER BUTTON INSIDE DRAW CALLBACK"),$(this).hasClass("activeColumnFilterButton")?($(this).removeClass("activeColumnFilterButton"),0==$(this).closest("tr").find(".activeColumnFilterButton").length&&($("#manageRequestsTable_wrapper > div > div > div > div.dataTables_scroll > div.dataTables_scrollHead").css("height",""),$("#manageRequestsTable_wrapper > div > div > div > div.DTFC_LeftWrapper > div.DTFC_LeftHeadWrapper").css("height",""))):($(".activeColumnFilterButton").removeClass("activeColumnFilterButton"),$(this).addClass("activeColumnFilterButton"),$("#manageRequestsTable_wrapper > div > div > div > div.dataTables_scroll > div.dataTables_scrollHead").css("height",""),$("#manageRequestsTable_wrapper > div > div > div > div.DTFC_LeftWrapper > div.DTFC_LeftHeadWrapper").css("height",""),$(".dataTables_scrollHead").height($($(this).parent().children()[1]).height()+$(".dataTables_scrollHead").height()+4),$(".DTFC_LeftHeadWrapper").height($($(this).parent().children()[1]).height()+$(".DTFC_LeftHeadWrapper").height()+4)),event.stopPropagation()}))},rowReorderHandler=async function(event,diff,edit){console.log(event),console.log(diff),console.log(edit);var manageRequestsTable=$("#manageRequestsTable").DataTable();if(diff.some(x=>[x.oldData,x.newData].includes(0)||[x.oldData,x.newData].includes(void 0)||[x.oldData,x.newData].includes(null))){var notificationTitle="Invalid Reorder Operation",notificationMsg="Cannot prioritize requests that have no priority.";return void 0!==window.invalidReorderNotification?window.invalidReorderNotification.update({title:notificationTitle,message:notificationMsg,type:"yellowNotification"}):window.invalidReorderNotification=$.notify({title:notificationTitle,message:notificationMsg},{delay:0,type:"yellowNotification",template:utilities().notifyJSTemplates.default,onClose:function(){window.invalidReorderNotification=void 0}}),void manageRequestsTable.draw(!1)}for(var transientRecordsPromises=[],i=0,ien=diff.length;i<ien;i++){$(diff[i].node).addClass("reordered");var sendObj={requestId:requestId=manageRequestsTable.row(diff[i].node).data().id},colName="";window.manageMyRequests?(colName="requested",sendObj.requestedOrder=diff[i].newData):(colName="assigned",sendObj.assignedOrder=diff[i].newData),transientRecordsPromises.push(ajaxModule().updateTransientRecords(sendObj,colName))}Promise.all(transientRecordsPromises).then((function(transientRecordsResults){if(transientRecordsResults.every(x=>"success"==x.result))displayUnsavedTableChanges();else{var errorRes=transientRecordsResults.find(x=>"success"!=x.result);swal("Warning!",errorRes.error,"warning")}manageRequestsTable.draw(!1)})).catch((function(){swal("Error In App Service","Request Timed Out","error")}))},resetRequests=function(){var colName="assigned";window.manageMyRequests&&(colName="requested"),ajaxModule().cancelReorder(colName).then((function(r){"object"==typeof r?"success"==r.result?closeUnsavedTableChanges(!0):swal("Error In App Service",r.error,"error"):swal("Error In App Service",r,"error")}))},checkTransColumnLock=function(requestTypeId){return new Promise((async function(resolve,reject){var inputObj={requestTypeId:requestTypeId},r=await ajaxModule().checkAssignedOrderLock(inputObj);"object"==typeof r?("success"==r.result?"lockedByCurrentUser"in r?displayUnsavedTableChanges():"locked"in r&&!window.manageMyRequests?(window.top.rowReorderLocked=!0,closeUnsavedTableChanges(),swal("Warning!",r.locked,"info")):(window.top.rowReorderLocked=!1,closeUnsavedTableChanges(),$("#lockMsg").text("")):swal("Warning!",r.error,"warning"),console.log(r)):(swal("Error In App Service","Request Timed Out","error"),reject()),resolve(!0)}))},checkTableDraft=async function(requestTypeId){if(window.manageMyRequests){var response=await ajaxModule().checkDraftRequestedOrder(requestTypeId);"success"==response.result&&response.data&&displayUnsavedTableChanges()}else await checkTransColumnLock(requestTypeId)},displayUnsavedTableChanges=function(){$("#manageRequestsTable").attr("hasChanges",!0),utilities().displayUnsavedChangesNotification(),$("#UpdateRequestsButtons").fadeIn("slow"),window.top.rowReorderLocked=!1,$("#lockMsg").text("")},closeUnsavedTableChanges=function(redraw=!1){$("#manageRequestsTable").attr("hasChanges",!1),utilities().hideUnsavedChangesNotification(),$("#UpdateRequestsButtons").fadeOut("fast"),redraw&&$("#manageRequestsTable").DataTable().draw()},getVisibleRequestTypes=function(){return new Promise((function(resolve,reject){let promiseArray=[];promiseArray.push(ajaxModule().getRequestTypesICanEdit()),promiseArray.push(ajaxModule().getRequestTypesICanView()),Promise.all(promiseArray).then((function(responses){let editableRequestTypesList=utilities().decodeServiceResponce(responses[0]),viewableRequestTypesList=utilities().decodeServiceResponce(responses[1]),returnArr=editableRequestTypesList;$.each(viewableRequestTypesList,(function(i,requestType){returnArr.find(x=>x.id==requestType.id&&x.displayName==requestType.displayName)||returnArr.push(requestType)})),resolve(returnArr)}))}))},populateRequestTypesList=function(){return new Promise((function(resolve,reject){var defaultOptions=null;getVisibleRequestTypes().then((function(processedRequestTypesArray){var dropdown=$("<select></select>");$.each(processedRequestTypesArray,(function(index,requestType){if(1!=requestType.disabled){var requestTypeOption=$("<option></option>").attr("value",index).attr("requesttypeid",requestType.id).text(requestType.displayName),reqTypeId;if(1==requestType.isDefault?(defaultOptions=index,requestTypeOption.attr("selected","selected"),dropdown.prepend(requestTypeOption)):dropdown.append(requestTypeOption),window.top!=window.self)window.parent.$("#requestTypeId").val()==requestType.id&&(preSelect=index);else 1==requestType.isDefault&&(defaultOptions=index)}!requestType.canAdd&&requestType.restrictAccess||(showMakeNewRequest=!0)})),utilities().sortDropdownlist(dropdown),$("select#manageRequestsTable_requestTypeDropdown").html(dropdown.html()),0==$("select#requestTypeDropdown").children().length&&(null!=defaultOptions?$(dropdown).val(defaultOptions):$(dropdown).val(0),window.savedFieldsOptionsHTML=dropdown.html(),$("select#requestTypeDropdown").html(window.savedFieldsOptionsHTML),window.top!=window.self&&$("select#requestTypeDropdown").val(preSelect)),resolve(!0)})).catch((function(response){console.error("error"),console.error(response),reject(!1)}))}))},documentReadyFunction;return{documentReadyFunction:function(){$("#basicLoadingModal").modal("show"),$("body").on("change","select#manageRequestsTable_requestTypeDropdown",(function(event){var thisRequestTypeId=parseInt($(this).find("option:selected").attr("requesttypeid"));checkTableDraft(thisRequestTypeId),initManageRequestsTable(thisRequestTypeId)})),$("table#manageRequestsTable > tbody").on("click","td.details-control",(function(event){var tr=$(this).closest("tr"),row=$("table#manageRequestsTable").DataTable().row(tr);row.child.isShown()?(row.child.hide(),tr.removeClass("shown")):(utilities().hideUnsavedChangesNotification(),ajaxModule().fetchSpecificRequest(row.data(),row.index()))})),$("body").on("click",".updateRequestsAssignedOrderButton",(function(event){ajaxModule().commitOrder("assigned").then((function(r){"object"==typeof r?"success"==r.result?closeUnsavedTableChanges(!0):swal("Error In App Service",r.error,"error"):swal("Error In App Service",r,"error")}))})),$("body").on("click",".updateRequestsRequestedOrderButton",(function(event){ajaxModule().commitOrder("requested").then((function(r){"object"==typeof r?"success"==r.result?closeUnsavedTableChanges(!0):swal("Error In App Service",r.error,"error"):swal("Error In App Service",r,"error")}))})),$("body").on("click","#resetRequests",(function(event){resetRequests()})),$("body").on("click","#requestEditorModal .requestEditorContainer .bottomButtons .requestEditorCancel",(function(event){window.allowRequestEditorHide=!0,$("#requestEditorModal").modal("hide")})),$(window).on("resize",(function(){"undefined"!=typeof resizeTimeout&&clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){utilities().resizeManageRequestsTable(),dataTableModule().resizeRequestItemsTableInRequest()}),200)})),$("#manageRequestsTable_wrapper .dataTables_scrollBody").scroll((function(){$("#manageRequestsTable_wrapper .dataTables_scrollHead").is(":visible")&&$("#manageRequestsTable_wrapper .dataTables_scrollHead").scrollLeft($("#manageRequestsTable_wrapper .dataTables_scrollBody").scrollLeft())})),$("#requestEditorModal").on("hidden.bs.modal",(function(){$("#requestEditorModal .dropdownEditorContainer").removeClass("makeVisible"),window.allowRequestEditorHide=!1,"true"==$("#manageRequestsTable").attr("hasChanges")?displayUnsavedTableChanges():utilities().closeUnsavedChangesNotification()})),$("#requestEditorModal").on("hide.bs.modal",(function(e){window.unsavedChangesNotificationOpen&&!window.allowRequestEditorHide&&(e.preventDefault(),e.stopImmediatePropagation(),console.log("Prevented modal from closing...")),$(window).trigger("resize"),window.CurrentPageMode="manageRequests"}));var promiseChain=[];promiseChain.push(populateRequestTypesList()),promiseChain.push(ajaxModule().processRequestTypesArray()),promiseChain.push(ajaxModule().populateRequestItemTypesList()),promiseChain.push(ajaxModule().populateSavedFieldsList()),Promise.all(promiseChain).then((function(){$("select#manageRequestsTable_requestTypeDropdown").change()})),$("#basicLoadingModal").modal("show")},checkTransColumnLock:checkTransColumnLock}},manageRequests=manageRequestsModule();$(document).ready((function(){manageRequests.documentReadyFunction()}));
//# sourceMappingURL=manageRequests.min.js.map